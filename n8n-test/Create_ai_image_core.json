{
  "name": "Create ai image_core",
  "nodes": [
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base64",
        "binaryPropertyName": "Image",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        4096,
        16
      ],
      "id": "fa74c078-a1a0-4618-8f07-98e1a8592b24",
      "name": "Convert Base64 To File"
    },
    {
      "parameters": {
        "operation": "resize",
        "dataPropertyName": "Image",
        "width": "={{ $('caculate subimage size').all()[0].json.resize_width }}",
        "height": "={{ $('caculate subimage size').all()[0].json.resize_height }}",
        "options": {}
      },
      "type": "n8n-nodes-base.editImage",
      "typeVersion": 1,
      "position": [
        5232,
        16
      ],
      "id": "767d60f7-587d-4fc0-9c41-b2dcd13c0480",
      "name": "Resize Image"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "binaryPropertyName": "Image",
        "destinationKey": "Info_Image",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        6704,
        16
      ],
      "id": "f4741283-b539-45b0-b25b-f94931250221",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1552,
        32
      ],
      "id": "1a3accb6-e822-40bf-9b6c-6919130726d4",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.Action.toString() }}",
                    "rightValue": "Update All",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7b914a94-9c2e-4249-a8f6-47d9fabac0fc"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "905c2106-f714-425d-9084-8365f76635f3",
                    "leftValue": "={{ $json.Action.toString() }}",
                    "rightValue": "Update Background-removed",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "37bb050f-20a9-4e33-bfd4-5fe0c745b881",
                    "leftValue": "={{ $json.Action.toString() }}",
                    "rightValue": "Update Original-Image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1344,
        16
      ],
      "id": "300008ff-40bc-4b1d-b25d-a5b40f9caf51",
      "name": "Switch"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://192.168.1.10:7777/api/products/images",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"productId\": \"{{ $json.ProductID }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1136,
        1936
      ],
      "id": "d8b0802e-22dc-46c8-996d-f731faecd99d",
      "name": "HTTP Request11"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://192.168.1.10:7777/api/products/update-ai-images",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"productNumber\": \n    \"{{ $('When Executed by Another Workflow').all()[0].json.ProductID }}\",\n  \"AIThumbNailImage\": \n    \"{{ $('HTTP Request11').all()[0].json.data.thumbNailImageBase64 }}\",\n  \"AIMainImageUrls\": \n    [{{ $json.mainImagesresultBase64 }}],\n  \n  \"AISubImageUrls\": \n    [{{ $json.subImagesresultBase64 }}]\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -800,
        1936
      ],
      "id": "c87060c7-0e58-4413-9be8-efa5d652a399",
      "name": "HTTP Request12"
    },
    {
      "parameters": {
        "jsCode": "// 모든 input items 가져오기\nconst items = $('HTTP Request11').all();\n\nlet mainImagesList = [];\nlet subImagesList = [];\n\nfor (const item of items) {\n  const arr = item.json.data.mainImagesBase64;\n  if (Array.isArray(arr)) {\n    mainImagesList.push(...arr); \n  }\n}\n\nfor (const item of items) {\n  const arr = item.json.data.subImagesBase64;\n  if (Array.isArray(arr)) {\n    subImagesList.push(...arr); \n  }\n}\n\nconst mainImagesbase64List = mainImagesList\n  .map(str => {\n    if (!str) return null;\n\n    const parts = str.split(\",\");\n    return parts[1] ? parts[1] : parts[0]; \n  })\n  .filter(b => b); \n\nconst subImagesbase64List = subImagesList\n  .map(str => {\n    if (!str) return null;\n\n    const parts = str.split(\",\");\n    return parts[1] ? parts[1] : parts[0]; \n  })\n  .filter(b => b); \n\n\n\nconst mainImagesresult = mainImagesbase64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); \n\nconst subImagesresult = subImagesbase64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); \n\nreturn [\n  {\n    json: {\n      mainImagesresultBase64: mainImagesresult,\n      subImagesresultBase64: subImagesresult\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -944,
        1936
      ],
      "id": "cbcc0847-c98a-4581-a32a-31f32050c055",
      "name": "Code in JavaScript62"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://{{ $json.IP }}/api/products/images",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"productId\": \"{{ $json.ProductID }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -992,
        0
      ],
      "id": "ad714881-fee9-4a47-8483-7a5e9679eb45",
      "name": "get images API"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a083101d-0214-49ee-ad64-8bcfd66539a3",
              "leftValue": "={{ $json.isAccessory}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "9e41bd93-2a87-40cc-af11-ab22f54d278d",
              "leftValue": "={{ $json.isBag}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -656,
        0
      ],
      "id": "61a5d98e-2ee3-4630-be43-463fbe58243a",
      "name": "is accessory?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://{{ $('When Executed by Another Workflow').all()[0].json.IP }}/api/products/update-ai-images",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"productNumber\": \n    \"{{ $('When Executed by Another Workflow').all()[0].json.ProductID }}\",\n  \"AIThumbNailImage\": \n    \"\",\n  \"AIMainImageUrls\": \n    [],\n  \n  \"AISubImageUrls\": \n    []\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -320,
        -192
      ],
      "id": "8c604813-86dc-40d7-beb7-4751a17c17f8",
      "name": "post images API"
    },
    {
      "parameters": {
        "jsCode": "// 모든 input items 가져오기\nconst items = $('get images API').all();\n\nlet mainImagesList = [];\nlet subImagesList = [];\n\nfor (const item of items) {\n  const arr = item.json.data.mainImagesBase64;\n  if (Array.isArray(arr)) {\n    mainImagesList.push(...arr); \n  }\n}\n\nfor (const item of items) {\n  const arr = item.json.data.subImagesBase64;\n  if (Array.isArray(arr)) {\n    subImagesList.push(...arr); \n  }\n}\n\nconst mainImagesbase64List = mainImagesList\n  .map(str => {\n    if (!str) return null;\n\n    const parts = str.split(\",\");\n    return parts[1] ? parts[1] : parts[0]; \n  })\n  .filter(b => b); \n\nconst subImagesbase64List = subImagesList\n  .map(str => {\n    if (!str) return null;\n\n    const parts = str.split(\",\");\n    return parts[1] ? parts[1] : parts[0]; \n  })\n  .filter(b => b); \n\n\n\nconst mainImagesresult = mainImagesbase64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); \n\nconst subImagesresult = subImagesbase64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); \n\nreturn [\n  {\n    json: {\n      mainImagesresultBase64: mainImagesresult,\n      subImagesresultBase64: subImagesresult\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        -192
      ],
      "id": "ea4edee3-12c0-48b1-a842-798ed74893c4",
      "name": "make postData"
    },
    {
      "parameters": {
        "jsCode": "const text = $input.first().json.data.category;\n// \"악세사리-\" 로 시작하거나 포함되어 있는지 검사\nconst isAccessory = text.includes(\"악세사리\");\nconst isBag = text.includes(\"가방\");\n\nreturn [\n  {\n    json: {\n      original: text,\n      isAccessory,\n      isBag\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -816,
        0
      ],
      "id": "8ce58b8d-0ce5-44f1-a082-b60913d702ac",
      "name": "check category"
    },
    {
      "parameters": {
        "jsCode": "// 입력 필드 이름만 변경해서 사용하세요.\nconst ThumbNailImage = $('get images API').all()[0].json.data.thumbNailImageBase64;\nconst SubImage = $('get images API').all()[0].json.data.subImageSumImage;   // ← 여기에 필드명 지정\n\n\n\nlet ThumbNailImageBase64 = null;\nlet SubImageBase64 = null;\n// 문자열인지 체크\nif (typeof ThumbNailImage === \"string\" && ThumbNailImage.includes(\",\")) {\n  ThumbNailImageBase64 = ThumbNailImage.split(\",\")[1];\n}\n\nif (typeof SubImage === \"string\" && SubImage.includes(\",\")) {\n  SubImageBase64 = SubImage.split(\",\")[1];\n}\n\nreturn [\n  {\n    json: {\n      ThumbNailImageBase64: ThumbNailImageBase64,\n      SubImageBase64: SubImageBase64\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        16
      ],
      "id": "9b2799bf-5bd9-418e-914c-45eda9e27ef7",
      "name": "make pure base64"
    },
    {
      "parameters": {
        "jsCode": "const category = $('get images API').all()[0].json.data.category;\n\nconst prompt = `[시스템 역할]\n당신은 엄격한 규정을 따르는 전문 패션 이커머스 에디터이며,\n카테고리와 첨부된 제품 이미지들을 기반으로 모델 착용 이미지를 생성해야 합니다.\n\n당신의 임무는 다음과 같습니다:\n**카테고리 : ${category}**를 기준으로\n첨부된 이미지 안에서 해당 카테고리에 해당하는 제품을 정확히 찾아내고\n그 제품을 모델이 착용한 새로운 착용컷 이미지를 생성하는 것입니다.\n\nI. [모델 페르소나 카드] – 일관성 유지 (Critical Model Consistency)\n모든 이미지에서 아래 모델 페르소나를 완전히 유지해야 합니다.\n성별/연령: 20대 후반–30대 초반의 세련된 한국 여성/남성\n얼굴 특징:\n\n얼굴 전체가 명확히 보임\n시크하고 무심한 표정\n입체적인 이목구비\n정면 또는 살짝 비켜가는 시선\n\n헤어:\n\n자연스러운 질감의 짧은 단발 또는 정돈된 미디엄\n짙은 갈색 컬러\n\n피부톤:\n\n매트하고 건강한 쿨톤\n자연스러운 메이크업\n\n분위기:\n\n도시적, 전문적, 하이엔드 매거진 화보 느낌\n\nII. 제품 식별 규칙 (카테고리 기반 Product Identification Rule)\n1) 첨부 이미지 속에서 해당 카테고리와 매칭되는 제품을 탐지\n\n카테고리 구조는 다음과 같이 구성됨:\n대분류-중분류-소분류\n예) 의류–스커트–롱, 악세사리–모자–비니 등\n\n이미지 속 실제 제품의 형태·재질·실루엣을 기반으로 가장 정확하게 매칭되는 제품을 선택.\n\n2) 선택된 제품의 모든 디테일을 그대로 유지\n\n✔ 색상 (Hue/Saturation/Brightness)\n✔ 실루엣\n✔ 주름\n✔ 패턴\n✔ 버튼·포켓 위치\n✔ 질감\n✔ 핏\n\n⚠ 원본과 단 1px도 다르게 생성되면 안 됨.\n\n3) 해당 제품을 모델이 자연스럽게 착용한 상태로 재구성\n\n제품 변형 금지\n\n왜곡 금지\n\n색 보정 금지\n\nIII. 이미지 생성 규칙 (상품 유지가 최우선)\n원본 상품이 절대적으로 동일해야 한다.\n\n색상 변경 금지\n➤ 원본 상품의 색상(Hue, Saturation, Brightness 포함 모든 Color Attribute)은 1px도 변화하면 안 된다.\n➤ AI가 자동 보정/화이트밸런스/조명 영향 등을 핑계로 색조가 바뀌는 것도 금지.\n➤ 원본 제품 색상은 RAW Color처럼 그대로 잠금 상태(Color-locked)로 유지해야 한다.\n디테일 변경 금지\n소재/핏/버튼/포켓 위치/패턴/천 질감 모두 동일하게 유지\n모델이 실제로 그 상품을 입은 것처럼 자연스럽게 재현할 것\n\n옷이 돋보이도록 코디는 더욱 세련되게 구성하되, 상품을 방해하지 않을 것.\n모델 얼굴은 꼭 보여야 한다.\n모델 포즈:\n\n모델은 정면을 보고 서 있으며, 한쪽 손은 바지 주머니에 넣고 다른 쪽 어깨에는 가방을 메고 있습니다.\n몸은 정면을 향하지만 시선은 약간 오른쪽\n전체적으로 편안하고 안정적인 스탠딩 포즈\n\n상세 이미지 비율: 1 : 1.2\n코디 규칙:\n\n코디되는 다른 의류는 체크 패턴 절대 금지\n하의는 다음 중 하나만 허용: 부츠컷 팬츠 / 슬랙스 와이드 핏\n신발은 다음 중 하나만 허용: 플랫 로퍼 / 운동화 (굽 높은 구두 절대 금지)\nwinter season → 짙은 색상\n가방은 명품 느낌 금지, 심플하고 미니멀한 디자인만 사용\n\n상품 디테일 재현 매우 중요:\n\n옷의 질감, 주름, 버튼, 실루엣, 컬러, 핏 모두 원본과 동일\n사진 속 조명/환경 변화에도 상품이 원본과 정확히 같아야 함\n\n\n⚡ 추가 규칙 — \"모델 다리 길이 증가 (Leg-Elongation Rule)\"\n아래 규칙을 새로 추가합니다. 필수 적용입니다.\n\n모델의 다리는 일반적인 비율보다 길고 슬림하게, 패션 화보 스타일의 롱 레그 비율을 적용하여 연출하십시오.\n단, 신체 비율이 부자연스럽지 않도록 프로 패션 촬영처럼 자연스럽게 연장하십시오.\n다리를 길게 만들 때에도 상품(외투/아우터/상의)의 핏이 왜곡되거나 변형되면 절대 안 된다.\n하의 실루엣(부츠컷/와이드핏)도 그대로 유지한 상태에서 전체적인 비율만 슬림하고 길어 보이도록 처리.\n발 위치·바닥·그림자도 현실적인 비례감으로 조정해 자연스러움을 유지할 것.\n\n\n🚫 III. 텍스트 생성 절대 금지 (NO TEXT GENERATION - CRITICAL)\n⚠️ 이 규칙은 최우선 적용됩니다.\n❌ 절대 금지 사항:\n\n이미지 내에 새로운 텍스트, 글자, 문자, 숫자, 기호를 생성하지 마십시오\n브랜드명, 로고, 워터마크, 라벨을 새로 만들지 마십시오\n옷에 글씨나 프린트를 추가하지 마십시오 (원본에 없는 경우)\n배경에 간판, 문구, 장식 텍스트를 넣지 마십시오\n어떤 형태의 텍스트도 AI가 임의로 생성해서는 안 됩니다\n\n\"DO NOT generate, add, or create ANY text, letters, numbers, logos, watermarks, or written elements that do not exist in the original image. Text generation is strictly prohibited.\"\n\nIV. 주의사항 (Critical)\n\n원본 상품 디테일이 1px도 바뀌면 안 된다\n이미지를 생성하더라도 텍스트, 설명, 정보 배치는 100% 동일하게 유지\n모델컷만 교체\n상품 실루엣/색상/질감 충실하게 복원\n다리 길이 증가 포함\n새로운 텍스트 생성 절대 금지\n전체 결과물은 \"진짜 모델이 그 상품을 착용한 것처럼\" 보여야 한다`;\n\n \n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        848,
        16
      ],
      "id": "4a274b98-eb26-4368-a211-0544e857397b",
      "name": "make pure thumbnailPrompt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $json.cleanedPrompt }} },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('make pure base64').all()[0].json.ThumbNailImageBase64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1024,
        16
      ],
      "id": "fd342c9b-5334-42d0-8ed1-e250c522e3ee",
      "name": "create thumbnail",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\n# ==========================================================\n# 1) base64 입력 받기\n# ==========================================================\nbase64_input = _input.first().json.candidates[0].content.parts[0].inlineData.data\n\nif not base64_input:\n    raise Exception(\"base64 이미지 데이터를 찾을 수 없습니다.\")\n\nimage_data = base64.b64decode(base64_input)\n\n# ==========================================================\n# 2) 이미지 로드\n# ==========================================================\nimg = Image.open(BytesIO(image_data))\n\n# ==========================================================\n# 3) 비율 유지 + width 700px 리사이즈\n# ==========================================================\ntarget_width = 700\nw, h = img.size\nratio = target_width / float(w)\ntarget_height = int(h * ratio)\n\nresized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n# ==========================================================\n# 4) 다시 base64로 변환\n# ==========================================================\nbuffered = BytesIO()\nresized_img.save(buffered, format=\"JPEG\")\noutput_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n# ==========================================================\n# 5) n8n Output (반드시 list 반환)\n# ==========================================================\nreturn [\n    {\n        \"width\": target_width,\n        \"height\": target_height,\n        \"ThumbnailImage_Base64\": output_base64\n    }\n]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1184,
        16
      ],
      "id": "0b05054e-a88e-4463-9324-4f55f00b3543",
      "name": "resize thumbnail"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $json.cleanedPrompt }} },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('resize thumbnail').all()[0].json.ThumbnailImage_Base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1824,
        -464
      ],
      "id": "95d84c3c-9930-4145-8ecd-3a25c516a8ca",
      "name": "create model-cut 1",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]\n당신은 엄격한 규정을 따르는 전문 패션 이커머스 에디터이며, 특정 모델의 일관된 외형을 유지해야 하는 임무를 받았습니다.\n\n임무:\n모델의 포즈만 아래 지시사항에 따라 교체된 새로운 이미지를 생성하십시오.\n\nI. [모델 페르소나 카드] – 일관성 유지 (Critical Model Consistency)\n- 20대 후반~30대 초반 세련된 한국 모델\n- 얼굴 전체 명확히 보임, 시크하고 무심한 표정\n- 입체적 이목구비\n- 시선: 정면 또는 약간 비켜감\n- 자연스러운 질감의 짧은 단발~미디엄 헤어, 짙은 갈색\n- 매트하고 건강한 쿨톤 피부, 자연스러운 메이크업\n- 분위기: 도시적, 전문적, 하이엔드 화보\n\nII. 이미지 생성 규칙 (원본 착장 100% 유지, 포즈만 변경)⚠️ 핵심 원칙: 인풋 이미지의 모델 착장을 완벽히 동일하게 유지하고, 포즈만 변경합니다.🔒 원본 착장 완전 보존 (CRITICAL - DO NOT MODIFY)\n상의/아우터: 원본과 100% 동일 (색상/핏/소재/버튼/포켓/질감/패턴/주름/디테일)\n하의: 원본 이미지의 하의 그대로 유지 (종류/색상/핏/소재 변경 금지)\n신발: 원본 이미지의 신발 그대로 유지 (종류/색상/스타일 변경 금지)\n가방/액세서리: 원본 이미지에 있는 그대로 유지 (추가/제거/변경 금지)\n전체 코디: 인풋 이미지의 착장을 1px도 변경하지 않음\n\n❌ 절대 금지:\n하의를 다른 종류로 교체\n신발을 다른 종류로 교체\n가방을 추가/제거/변경\n액세서리를 추가/제거/변경\n원본에 없는 아이템 추가\n원본에 있는 아이템 제거\n\nIII. Leg-Elongation Rule (필수 적용)\n- 모델의 다리를 자연스럽게 길고 슬림하게 연출\n- 신체가 부자연스럽지 않도록 프로 패션 촬영 비율로 조정\n- 상의/아우터 실루엣은 변형 금지  \n- 하의 실루엣 그대로 유지  \n- 발·바닥·그림자 자연스러운 비례 유지\n\nIV. 주의사항\n- 원본 상품 디테일 1px도 변경 금지\n- 텍스트/레이아웃 100% 동일하게 유지\n- 모델컷만 교체\n- 상품 재현 정확도 최우선\n\n[포즈 지시사항]\n모델은 한 손은 바지 주머니에 넣고, 다른 손으로는 가방을 들고 있습니다.\n몸의 중심은 한쪽 다리에 실려 있으며, 자연스럽고 안정적인 스탠딩 포즈입니다.\n시선은 가볍게 정면을 향하거나 약간 옆으로.\n전체적으로 패션 화보 같은 여유로운 분위기.\n상품의 핏·색상·실루엣은 원본과 동일하게 유지하십시오.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        -464
      ],
      "id": "1057b053-6a45-46e7-8448-98b1281fd6c6",
      "name": "make pure model-cut prompt 1"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]\n당신은 엄격한 규정을 따르는 전문 패션 이커머스 에디터이며, 특정 모델의 일관된 외형을 유지해야 하는 임무를 받았습니다.\n\n임무:\n모델의 포즈만 아래 지시사항에 따라 교체된 새로운 이미지를 생성하십시오.\n\n\nI. [모델 페르소나 카드] – 일관성 유지 (Critical Model Consistency)\n- 20대 후반~30대 초반 세련된 한국 모델\n- 얼굴 전체 명확히 보임, 시크하고 무심한 표정\n- 입체적 이목구비\n- 시선: 정면 또는 약간 비켜감\n- 자연스러운 질감의 짧은 단발~미디엄 헤어, 짙은 갈색\n- 매트하고 건강한 쿨톤 피부, 자연스러운 메이크업\n- 분위기: 도시적, 전문적, 하이엔드 화보\n\nII. 이미지 생성 규칙 (원본 착장 100% 유지, 포즈만 변경)⚠️ 핵심 원칙: 인풋 이미지의 모델 착장을 완벽히 동일하게 유지하고, 포즈만 변경합니다.🔒 원본 착장 완전 보존 (CRITICAL - DO NOT MODIFY)\n상의/아우터: 원본과 100% 동일 (색상/핏/소재/버튼/포켓/질감/패턴/주름/디테일)\n하의: 원본 이미지의 하의 그대로 유지 (종류/색상/핏/소재 변경 금지)\n신발: 원본 이미지의 신발 그대로 유지 (종류/색상/스타일 변경 금지)\n가방/액세서리: 원본 이미지에 있는 그대로 유지 (추가/제거/변경 금지)\n전체 코디: 인풋 이미지의 착장을 1px도 변경하지 않음\n\n❌ 절대 금지:\n하의를 다른 종류로 교체\n신발을 다른 종류로 교체\n가방을 추가/제거/변경\n액세서리를 추가/제거/변경\n원본에 없는 아이템 추가\n원본에 있는 아이템 제거\n\nIII. Leg-Elongation Rule (필수 적용)\n- 모델의 다리를 자연스럽게 길고 슬림하게 연출\n- 신체가 부자연스럽지 않도록 프로 패션 촬영 비율로 조정\n- 상의/아우터 실루엣은 변형 금지  \n- 하의 실루엣 그대로 유지  \n- 발·바닥·그림자 자연스러운 비례 유지\n\nIV. 주의사항\n- 원본 상품 디테일 1px도 변경 금지\n- 텍스트/레이아웃 100% 동일하게 유지\n- 모델컷만 교체\n- 상품 재현 정확도 최우선\n\n[포즈 지시사항]\nFull body shot.\n모델이 자연스럽게 걸어오는 듯한 워킹 포즈를 취합니다.\n한 발은 앞으로 내딛고, 다른 발은 뒤에서 따라오는 자연스러운 보폭.\n팔은 걸음에 따라 살짝 흔들리는 듯한 편안한 동작.\n시선은 약간 아래쪽이나 정면 가까이 유지.\n과장되지 않은 자연스러운 런웨이 스타일 걷기 포즈.\n전체적으로 도시적이고 자신감 있는 패션 워킹 느낌.\n실루엣이 흐트러지지 않고 깔끔하게 유지되도록 처리.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        -304
      ],
      "id": "f7a82d08-e819-4d56-8857-79d846e61ac1",
      "name": "make pure model-cut prompt 2"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]\n당신은 엄격한 규정을 따르는 전문 패션 이커머스 에디터이며, 특정 모델의 일관된 외형을 유지해야 하는 임무를 받았습니다.\n\n임무:\n모델의 포즈만 아래 지시사항에 따라 교체된 새로운 이미지를 생성하십시오.\n\n\nI. [모델 페르소나 카드] – 일관성 유지 (Critical Model Consistency)\n- 20대 후반~30대 초반 세련된 한국 모델\n- 얼굴 전체 명확히 보임, 시크하고 무심한 표정\n- 입체적 이목구비\n- 시선: 정면 또는 약간 비켜감\n- 자연스러운 질감의 짧은 단발~미디엄 헤어, 짙은 갈색\n- 매트하고 건강한 쿨톤 피부, 자연스러운 메이크업\n- 분위기: 도시적, 전문적, 하이엔드 화보\n\nII. 이미지 생성 규칙 (원본 착장 100% 유지, 포즈만 변경)⚠️ 핵심 원칙: 인풋 이미지의 모델 착장을 완벽히 동일하게 유지하고, 포즈만 변경합니다.🔒 원본 착장 완전 보존 (CRITICAL - DO NOT MODIFY)\n상의/아우터: 원본과 100% 동일 (색상/핏/소재/버튼/포켓/질감/패턴/주름/디테일)\n하의: 원본 이미지의 하의 그대로 유지 (종류/색상/핏/소재 변경 금지)\n신발: 원본 이미지의 신발 그대로 유지 (종류/색상/스타일 변경 금지)\n가방/액세서리: 원본 이미지에 있는 그대로 유지 (추가/제거/변경 금지)\n전체 코디: 인풋 이미지의 착장을 1px도 변경하지 않음\n\n❌ 절대 금지:\n하의를 다른 종류로 교체\n신발을 다른 종류로 교체\n가방을 추가/제거/변경\n액세서리를 추가/제거/변경\n원본에 없는 아이템 추가\n원본에 있는 아이템 제거\n\nIII. Leg-Elongation Rule (필수 적용)\n- 모델의 다리를 자연스럽게 길고 슬림하게 연출\n- 신체가 부자연스럽지 않도록 프로 패션 촬영 비율로 조정\n- 상의/아우터 실루엣은 변형 금지  \n- 하의 실루엣 그대로 유지  \n- 발·바닥·그림자 자연스러운 비례 유지\n\nIV. 주의사항\n- 원본 상품 디테일 1px도 변경 금지\n- 텍스트/레이아웃 100% 동일하게 유지\n- 모델컷만 교체\n- 상품 재현 정확도 최우선\n\n[포즈 지시사항]\n모델은 정면을 보고 서 있으며,\n두 손을 모두 바지 주머니에 넣고 있습니다.\n어깨는 아주 약간 앞으로 기울어져 자연스러운 무심한 느낌을 줍니다.\n시선은 정면을 향하며, 시크하고 편안한 스탠딩 포즈입니다.\n상품 실루엣과 질감은 그대로 유지하십시오.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        -128
      ],
      "id": "94cfbdcb-90dc-419d-ab42-ee837383338b",
      "name": "make pure model-cut prompt 3"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]\n당신은 엄격한 규정을 따르는 전문 패션 이커머스 에디터이며, 특정 모델의 일관된 외형을 유지해야 하는 임무를 받았습니다.\n\n임무:\n머리는 살짝 기울어 있으며, 시선은 카메라를 벗어나 옆을 향합니다.\n\n\nI. [모델 페르소나 카드] – 일관성 유지 (Critical Model Consistency)\n- 20대 후반~30대 초반 세련된 한국 모델\n- 얼굴 전체 명확히 보임, 시크하고 무심한 표정\n- 입체적 이목구비\n- 시선: 정면 또는 약간 비켜감\n- 자연스러운 질감의 짧은 단발~미디엄 헤어, 짙은 갈색\n- 매트하고 건강한 쿨톤 피부, 자연스러운 메이크업\n- 분위기: 도시적, 전문적, 하이엔드 화보\n\nII. 이미지 생성 규칙 (원본 착장 100% 유지, 포즈만 변경)⚠️ 핵심 원칙: 인풋 이미지의 모델 착장을 완벽히 동일하게 유지하고, 포즈만 변경합니다.🔒 원본 착장 완전 보존 (CRITICAL - DO NOT MODIFY)\n상의/아우터: 원본과 100% 동일 (색상/핏/소재/버튼/포켓/질감/패턴/주름/디테일)\n하의: 원본 이미지의 하의 그대로 유지 (종류/색상/핏/소재 변경 금지)\n신발: 원본 이미지의 신발 그대로 유지 (종류/색상/스타일 변경 금지)\n가방/액세서리: 원본 이미지에 있는 그대로 유지 (추가/제거/변경 금지)\n전체 코디: 인풋 이미지의 착장을 1px도 변경하지 않음\n\n❌ 절대 금지:\n하의를 다른 종류로 교체\n신발을 다른 종류로 교체\n가방을 추가/제거/변경\n액세서리를 추가/제거/변경\n원본에 없는 아이템 추가\n원본에 있는 아이템 제거\n\nIII. Leg-Elongation Rule (필수 적용)\n- 모델의 다리를 자연스럽게 길고 슬림하게 연출\n- 신체가 부자연스럽지 않도록 프로 패션 촬영 비율로 조정\n- 상의/아우터 실루엣은 변형 금지  \n- 하의 실루엣 그대로 유지  \n- 발·바닥·그림자 자연스러운 비례 유지\n\nIV. 주의사항\n- 원본 상품 디테일 1px도 변경 금지\n- 텍스트/레이아웃 100% 동일하게 유지\n- 모델컷만 교체\n- 상품 재현 정확도 최우선\n\n[포즈 지시사항]\nMedium shot(허리~가슴 위 중심 구도).\n모델은 양팔을 가슴 앞에서 부드럽게 감싸듯이 교차하고 있습니다.\n머리는 살짝 기울어 있으며, 시선은 카메라를 벗어나 옆을 향합니다.\n부드러운 바디 랭귀지, 패션 화보 같은 무심한 매력.\n상품 상의 디테일은 절대 변형 없이 100% 재현하십시오.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        48
      ],
      "id": "c77b3e33-d3a3-4385-a9d2-52fbb82ff042",
      "name": "make pure model-cut prompt 4"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]\n당신은 엄격한 규정을 따르는 전문 패션 이커머스 에디터이며, 특정 모델의 일관된 외형을 유지해야 하는 임무를 받았습니다.\n\n임무:\n모델의 포즈만 아래 지시사항에 따라 교체된 새로운 이미지를 생성하십시오.\n\n\nI. [모델 페르소나 카드] – 일관성 유지 (Critical Model Consistency)\n- 20대 후반~30대 초반 세련된 한국 모델\n- 얼굴 전체 명확히 보임, 시크하고 무심한 표정\n- 입체적 이목구비\n- 시선: 정면 또는 약간 비켜감\n- 자연스러운 질감의 짧은 단발~미디엄 헤어, 짙은 갈색\n- 매트하고 건강한 쿨톤 피부, 자연스러운 메이크업\n- 분위기: 도시적, 전문적, 하이엔드 화보\n\nII. 이미지 생성 규칙 (원본 착장 100% 유지, 포즈만 변경)⚠️ 핵심 원칙: 인풋 이미지의 모델 착장을 완벽히 동일하게 유지하고, 포즈만 변경합니다.🔒 원본 착장 완전 보존 (CRITICAL - DO NOT MODIFY)\n상의/아우터: 원본과 100% 동일 (색상/핏/소재/버튼/포켓/질감/패턴/주름/디테일)\n하의: 원본 이미지의 하의 그대로 유지 (종류/색상/핏/소재 변경 금지)\n신발: 원본 이미지의 신발 그대로 유지 (종류/색상/스타일 변경 금지)\n가방/액세서리: 원본 이미지에 있는 그대로 유지 (추가/제거/변경 금지)\n전체 코디: 인풋 이미지의 착장을 1px도 변경하지 않음\n\n❌ 절대 금지:\n하의를 다른 종류로 교체\n신발을 다른 종류로 교체\n가방을 추가/제거/변경\n액세서리를 추가/제거/변경\n원본에 없는 아이템 추가\n원본에 있는 아이템 제거\n\nIII. Leg-Elongation Rule (필수 적용)\n- 모델의 다리를 자연스럽게 길고 슬림하게 연출\n- 신체가 부자연스럽지 않도록 프로 패션 촬영 비율로 조정\n- 상의/아우터 실루엣은 변형 금지  \n- 하의 실루엣 그대로 유지  \n- 발·바닥·그림자 자연스러운 비례 유지\n\nIV. 주의사항\n- 원본 상품 디테일 1px도 변경 금지\n- 텍스트/레이아웃 100% 동일하게 유지\n- 모델컷만 교체\n- 상품 재현 정확도 최우선\n\n[포즈 지시사항]\nFull body shot, 로우 앵글 느낌.\n모델은 두 손을 바지 주머니에 넣고 편안히 서 있습니다.\n머리는 옆으로 돌려 측면 프로필 라인이 보이도록 합니다.\n시선은 멀리 다른 곳을 바라봅니다.\n하체 비율이 길고 슬림하게 강조된 패션 화보 스타일로 연출하십시오.\n상품의 핏과 디테일은 변형 금지.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        208
      ],
      "id": "a1a4af10-f10f-45b7-9413-aebd40ca433d",
      "name": "make pure model-cut prompt 5"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]\n당신은 엄격한 규정을 따르는 전문 패션 이커머스 에디터이며, 특정 모델의 일관된 외형을 유지해야 하는 임무를 받았습니다.\n\n임무:\n모델의 포즈만 아래 지시사항에 따라 교체된 새로운 이미지를 생성하십시오.\n\n\nI. [모델 페르소나 카드] – 일관성 유지 (Critical Model Consistency)\n- 20대 후반~30대 초반 세련된 한국 모델\n- 얼굴 전체 명확히 보임, 시크하고 무심한 표정\n- 입체적 이목구비\n- 시선: 정면 또는 약간 비켜감\n- 자연스러운 질감의 짧은 단발~미디엄 헤어, 짙은 갈색\n- 매트하고 건강한 쿨톤 피부, 자연스러운 메이크업\n- 분위기: 도시적, 전문적, 하이엔드 화보\n\nII. 이미지 생성 규칙 (원본 착장 100% 유지, 포즈만 변경)⚠️ 핵심 원칙: 인풋 이미지의 모델 착장을 완벽히 동일하게 유지하고, 포즈만 변경합니다.🔒 원본 착장 완전 보존 (CRITICAL - DO NOT MODIFY)\n상의/아우터: 원본과 100% 동일 (색상/핏/소재/버튼/포켓/질감/패턴/주름/디테일)\n하의: 원본 이미지의 하의 그대로 유지 (종류/색상/핏/소재 변경 금지)\n신발: 원본 이미지의 신발 그대로 유지 (종류/색상/스타일 변경 금지)\n가방/액세서리: 원본 이미지에 있는 그대로 유지 (추가/제거/변경 금지)\n전체 코디: 인풋 이미지의 착장을 1px도 변경하지 않음\n\n❌ 절대 금지:\n하의를 다른 종류로 교체\n신발을 다른 종류로 교체\n가방을 추가/제거/변경\n액세서리를 추가/제거/변경\n원본에 없는 아이템 추가\n원본에 있는 아이템 제거\n\nIII. Leg-Elongation Rule (필수 적용)\n- 모델의 다리를 자연스럽게 길고 슬림하게 연출\n- 신체가 부자연스럽지 않도록 프로 패션 촬영 비율로 조정\n- 상의/아우터 실루엣은 변형 금지  \n- 하의 실루엣 그대로 유지  \n- 발·바닥·그림자 자연스러운 비례 유지\n\nIV. 주의사항\n- 원본 상품 디테일 1px도 변경 금지\n- 텍스트/레이아웃 100% 동일하게 유지\n- 모델컷만 교체\n- 상품 재현 정확도 최우선\n\n[포즈 지시사항]\nFull body shot.\n모델은 심플한 블록 또는 큐브 위에 자연스럽게 앉아 있습니다.\n다리는 편안하게 교차하고, 시선은 무릎이나 손쪽을 보며 아래로 향합니다.\n한 손에는 작은 오브젝트(예: 휴대폰 또는 작은 소품)를 들고 있습니다.\n자연스러운 캐주얼 패션 촬영 느낌으로 연출하십시오.\n상품 실루엣과 색상, 질감은 절대 변경하지 마십시오.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        368
      ],
      "id": "61c064c1-0142-4482-b36f-5aa2bc32b875",
      "name": "make pure model-cut prompt 6"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\n# ==========================================================\n# 1) base64 입력 받기\n# ==========================================================\nbase64_input = _input.first().json.candidates[0].content.parts[0].inlineData.data\n\nif not base64_input:\n    raise Exception(\"base64 이미지 데이터를 찾을 수 없습니다.\")\n\nimage_data = base64.b64decode(base64_input)\n\n# ==========================================================\n# 2) 이미지 로드\n# ==========================================================\nimg = Image.open(BytesIO(image_data))\n\n# ==========================================================\n# 3) 비율 유지 + width 700px 리사이즈\n# ==========================================================\ntarget_width = 700\nw, h = img.size\nratio = target_width / float(w)\ntarget_height = int(h * ratio)\n\nresized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n# ==========================================================\n# 4) 다시 base64로 변환\n# ==========================================================\nbuffered = BytesIO()\nresized_img.save(buffered, format=\"JPEG\")\noutput_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n# ==========================================================\n# 5) n8n Output (반드시 list 반환)\n# ==========================================================\nreturn [\n    {\n        \"width\": target_width,\n        \"height\": target_height,\n        \"ModelImage_Base64\": output_base64\n    }\n]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        -464
      ],
      "id": "109a9172-edda-469f-b254-d24aeed5e0bc",
      "name": "resize model-cut 1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('resize thumbnail').all()[0].json.ThumbnailImage_Base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1824,
        -304
      ],
      "id": "f0bff960-709d-4df9-8399-38b2d9d7028d",
      "name": "create model-cut 2",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('resize thumbnail').all()[0].json.ThumbnailImage_Base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1824,
        -128
      ],
      "id": "6809701f-e966-4c24-9fa4-c46644590f50",
      "name": "create model-cut 3",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('resize thumbnail').all()[0].json.ThumbnailImage_Base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1824,
        48
      ],
      "id": "7b887ea1-9a03-48f6-9ddf-7e14a68ddaf6",
      "name": "create model-cut 4",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('resize thumbnail').all()[0].json.ThumbnailImage_Base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1824,
        208
      ],
      "id": "660ddf34-0909-413e-99a4-6e020251f981",
      "name": "create model-cut 5",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('resize thumbnail').all()[0].json.ThumbnailImage_Base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1824,
        368
      ],
      "id": "6de8c63e-1ecb-47d5-b628-d0e8959c1f5c",
      "name": "create model-cut 6",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\n# ==========================================================\n# 1) base64 입력 받기\n# ==========================================================\nbase64_input = _input.first().json.candidates[0].content.parts[0].inlineData.data\n\nif not base64_input:\n    raise Exception(\"base64 이미지 데이터를 찾을 수 없습니다.\")\n\nimage_data = base64.b64decode(base64_input)\n\n# ==========================================================\n# 2) 이미지 로드\n# ==========================================================\nimg = Image.open(BytesIO(image_data))\n\n# ==========================================================\n# 3) 비율 유지 + width 700px 리사이즈\n# ==========================================================\ntarget_width = 700\nw, h = img.size\nratio = target_width / float(w)\ntarget_height = int(h * ratio)\n\nresized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n# ==========================================================\n# 4) 다시 base64로 변환\n# ==========================================================\nbuffered = BytesIO()\nresized_img.save(buffered, format=\"JPEG\")\noutput_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n# ==========================================================\n# 5) n8n Output (반드시 list 반환)\n# ==========================================================\nreturn [\n    {\n        \"width\": target_width,\n        \"height\": target_height,\n        \"ModelImage_Base64\": output_base64\n    }\n]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        -304
      ],
      "id": "59cabb48-5c49-402e-8dac-89808199a0aa",
      "name": "resize model-cut 2"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\n# ==========================================================\n# 1) base64 입력 받기\n# ==========================================================\nbase64_input = _input.first().json.candidates[0].content.parts[0].inlineData.data\n\nif not base64_input:\n    raise Exception(\"base64 이미지 데이터를 찾을 수 없습니다.\")\n\nimage_data = base64.b64decode(base64_input)\n\n# ==========================================================\n# 2) 이미지 로드\n# ==========================================================\nimg = Image.open(BytesIO(image_data))\n\n# ==========================================================\n# 3) 비율 유지 + width 700px 리사이즈\n# ==========================================================\ntarget_width = 700\nw, h = img.size\nratio = target_width / float(w)\ntarget_height = int(h * ratio)\n\nresized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n# ==========================================================\n# 4) 다시 base64로 변환\n# ==========================================================\nbuffered = BytesIO()\nresized_img.save(buffered, format=\"JPEG\")\noutput_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n# ==========================================================\n# 5) n8n Output (반드시 list 반환)\n# ==========================================================\nreturn [\n    {\n        \"width\": target_width,\n        \"height\": target_height,\n        \"ModelImage_Base64\": output_base64\n    }\n]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        -128
      ],
      "id": "0051098f-2645-4c8e-959e-c444466be320",
      "name": "resize model-cut 3"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\n# ==========================================================\n# 1) base64 입력 받기\n# ==========================================================\nbase64_input = _input.first().json.candidates[0].content.parts[0].inlineData.data\n\nif not base64_input:\n    raise Exception(\"base64 이미지 데이터를 찾을 수 없습니다.\")\n\nimage_data = base64.b64decode(base64_input)\n\n# ==========================================================\n# 2) 이미지 로드\n# ==========================================================\nimg = Image.open(BytesIO(image_data))\n\n# ==========================================================\n# 3) 비율 유지 + width 700px 리사이즈\n# ==========================================================\ntarget_width = 700\nw, h = img.size\nratio = target_width / float(w)\ntarget_height = int(h * ratio)\n\nresized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n# ==========================================================\n# 4) 다시 base64로 변환\n# ==========================================================\nbuffered = BytesIO()\nresized_img.save(buffered, format=\"JPEG\")\noutput_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n# ==========================================================\n# 5) n8n Output (반드시 list 반환)\n# ==========================================================\nreturn [\n    {\n        \"width\": target_width,\n        \"height\": target_height,\n        \"ModelImage_Base64\": output_base64\n    }\n]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        48
      ],
      "id": "9ad236fb-42fb-4ee9-88fb-c75da697d177",
      "name": "resize model-cut 4"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\n# ==========================================================\n# 1) base64 입력 받기\n# ==========================================================\nbase64_input = _input.first().json.candidates[0].content.parts[0].inlineData.data\n\nif not base64_input:\n    raise Exception(\"base64 이미지 데이터를 찾을 수 없습니다.\")\n\nimage_data = base64.b64decode(base64_input)\n\n# ==========================================================\n# 2) 이미지 로드\n# ==========================================================\nimg = Image.open(BytesIO(image_data))\n\n# ==========================================================\n# 3) 비율 유지 + width 700px 리사이즈\n# ==========================================================\ntarget_width = 700\nw, h = img.size\nratio = target_width / float(w)\ntarget_height = int(h * ratio)\n\nresized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n# ==========================================================\n# 4) 다시 base64로 변환\n# ==========================================================\nbuffered = BytesIO()\nresized_img.save(buffered, format=\"JPEG\")\noutput_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n# ==========================================================\n# 5) n8n Output (반드시 list 반환)\n# ==========================================================\nreturn [\n    {\n        \"width\": target_width,\n        \"height\": target_height,\n        \"ModelImage_Base64\": output_base64\n    }\n]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        208
      ],
      "id": "68360c4e-7145-447a-a1e2-eba9e54636a9",
      "name": "resize model-cut 5"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\n# ==========================================================\n# 1) base64 입력 받기\n# ==========================================================\nbase64_input = _input.first().json.candidates[0].content.parts[0].inlineData.data\n\nif not base64_input:\n    raise Exception(\"base64 이미지 데이터를 찾을 수 없습니다.\")\n\nimage_data = base64.b64decode(base64_input)\n\n# ==========================================================\n# 2) 이미지 로드\n# ==========================================================\nimg = Image.open(BytesIO(image_data))\n\n# ==========================================================\n# 3) 비율 유지 + width 700px 리사이즈\n# ==========================================================\ntarget_width = 700\nw, h = img.size\nratio = target_width / float(w)\ntarget_height = int(h * ratio)\n\nresized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n# ==========================================================\n# 4) 다시 base64로 변환\n# ==========================================================\nbuffered = BytesIO()\nresized_img.save(buffered, format=\"JPEG\")\noutput_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n# ==========================================================\n# 5) n8n Output (반드시 list 반환)\n# ==========================================================\nreturn [\n    {\n        \"width\": target_width,\n        \"height\": target_height,\n        \"ModelImage_Base64\": output_base64\n    }\n]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        368
      ],
      "id": "fac312f8-8760-4658-be99-c20bd6370920",
      "name": "resize model-cut 6"
    },
    {
      "parameters": {
        "numberInputs": 6
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2432,
        -48
      ],
      "id": "d3db51f8-10f5-4ac4-8c8c-7bd3d32b96f4",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// 모든 input items 가져오기\nconst items = $input.all();\n\n// Base64 원본 모아서 저장할 배열\nlet rawList = [];\n\nfor (const item of items) {\n  const value = item.json.ModelImage_Base64;\n\n  if (!value) continue;\n\n  // 1) 배열인 경우\n  if (Array.isArray(value)) {\n    rawList.push(...value);\n  } \n  // 2) 문자열인 경우\n  else if (typeof value === \"string\") {\n    rawList.push(value);\n  }\n}\n\n// base64만 추출\nconst base64List = rawList\n  .map(str => {\n    if (!str) return null;\n\n    // data URL인지 확인\n    const parts = str.split(\",\");\n    return parts[1] ? parts[1] : parts[0];\n  })\n  .filter(b => b);\n\n// \"값\", \"값\", \"값\" 형태로 변환\nconst result = base64List.map(b => `\"${b}\"`).join(\", \");\n\nreturn [\n  {\n    json: {\n      ModelImage_Base64: result\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2656,
        16
      ],
      "id": "07340423-b8cf-4419-ace2-730ca2b47560",
      "name": "merge model-cut images"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=당신은 전문 의류 전처리 품질검사 AI 에이전트입니다.\n입력된 제품 이미지가 CUTOUT(의류만 분리) 작업을 수행하기에 적합한지를 판단하는 역할을 합니다.\n어떤 이미지든 직접 생성하거나 수정하지 않으며, 오직 “분석/판단”만 수행합니다.\n\n🎯 [AI의 핵심 임무]\n\n입력된 이미지를 보고 아래 항목을 정확하게 평가하시오:\n\n1) 의류가 정면을 향하고 있는가?\n\n2) 의류 전체가 프레임 안에 온전히 포함되어 있는가?\n   - 일부가 잘려 있다면 실패로 판단\n\n3) 심한 그림자, 어두운 영역, 배경 복잡도 등 CUTOUT 정확도를 방해하는 요소는 없는가?\n\n4) 색상 왜곡 가능성이 있는 조명(강한 역광/컬러조명)이 존재하는가?\n\n5) 전체적으로 CUTOUT이 “정확하게 생성될 가능성”을 High / Medium / Low 로 평가하시오.\n\n   📌 *white_background = true 조건 (아주 엄격함)*  \n   다음 조건을 모두 충족해야 `\"is_white_background\": true` 로 판정한다:\n\n   - 배경이 단색 흰색 또는 회색같은 단색이어야 한다.  \n   - 배경에 **사람, 신체 일부(머리, 얼굴, 팔, 손, 다리), 머리카락, 그림자 실루엣, 가구, 소품, 악세서리, 장식물 등 단 하나라도 존재하면 false**  \n   - 배경에 **패턴, 텍스처, 그라데이션, 색 번짐, 노이즈, 그림자 얼룩** 등이 보이면 false  \n   - **제품 외 객체가 프레임 안에 존재하면 무조건 false**  \n   - 의류 자체의 자연 그림자(밑단 아래 약한 회색 그림자)는 허용  \n   - 단순 흰 배경 + 오직 제품 하나만 있는 구성일 때만 true  \n   - 즉, \"스튜디오 누끼샷\"처럼 **사람 없이 순수 제품만 촬영된 이미지**여야 한다.\n\n   위 조건 중 하나라도 불충족하면 `\"is_white_background\": false` 로 판정한다.\n\n────────────────────────────\n📌 [정면 기준 판단 규칙]\n\n다음 조건을 충족하면 “정면”으로 간주:\n- 의류 중심선(지퍼, 버튼 라인)이 수직에 가깝다\n- 좌우 소매 길이가 크게 다르지 않다\n- 어깨 라인이 비대칭으로 기울지 않았다\n- 몸통이 비틀리거나 과하게 회전하지 않았다\n- 제품 각도(치우침, 옆모습)가 심하지 않다\n\n────────────────────────────\n📌 [CUTOUT 가능성 판단 기준]\n\n다음 요소가 하나라도 심각하면 CUTOUT 가능성 Low:\n- 인체 실루엣이 의류 형태를 가림\n- 배경과 의류 색상이 비슷해 경계가 흐림\n- 높은 잡음, 저해상도, 흔들림, 블러\n- 의류 일부가 프레임 밖으로 나감\n- 머리카락/손/팔 등 신체가 의류를 가림\n- 강한 그림자/반사로 경계 인식이 어려움\n\n────────────────────────────\n📌 [AI 출력 형식 — 반드시 아래 형식으로만 반환]\n\n{\n  \"is_front_facing\": true/false,\n  \"clothing_fully_visible\": true/false,\n  \"is_white_background\": true/false,\n  \"cutout_quality\": \"High\" | \"Medium\" | \"Low\",\n  \"reason\": \"판단 근거를 간단히 기술\"\n}\n",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3600,
        672
      ],
      "id": "d304a4ee-1bd9-4c3b-b2fc-a17f038cae81",
      "name": "AI Agent4"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3600,
        880
      ],
      "id": "cc334fcb-89cf-417f-a6c7-3730974f8e4e",
      "name": "Google Gemini Chat Model4",
      "credentials": {
        "googlePalmApi": {
          "id": "e7t27ilShPQLOWu7",
          "name": "Google Geminie Soonicron API"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "1"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        3696,
        880
      ],
      "id": "2869dc2d-ab49-48ac-ac1c-01e5351229a4",
      "name": "Simple Memory4"
    },
    {
      "parameters": {
        "jsCode": "const mainImageUrls = $('get images API').all()[0].json.data.mainImagesBase64 || [];\n\nreturn mainImageUrls.map((mainRaw) => {\n\n  // \"data:image/...,\" 제거\n  const mainPure = mainRaw.split(',')[1] || mainRaw;\n\n  return {\n    json: {\n      mainImageBase64: mainPure\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3200,
        672
      ],
      "id": "7cf7c0d0-477d-407d-b364-42d9d9b3c1d5",
      "name": "make pure mainImages base64"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "mainImageBase64",
        "binaryPropertyName": "Image",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        3408,
        672
      ],
      "id": "75a76339-9fd6-4e1d-aa7f-a5e81b74cb8c",
      "name": "convert imageFIle"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// 각 아이템을 개별적으로 처리하여 결과 아이템 배열 생성\nconst results = items.map(i => {\n  const raw = i.json.output;\n\n  // ```json ``` 블록 제거\n  const cleaned = String(raw ?? \"\")\n    .replace(/```json/g, \"\")\n    .replace(/```/g, \"\")\n    .trim();\n\n  // JSON 파싱\n  let parsed;\n  try {\n    parsed = JSON.parse(cleaned);\n  } catch (e) {\n    parsed = { error: \"JSON parsing failed\", raw: cleaned };\n  }\n\n  // 개별 아이템으로 반환\n  return {\n    json: parsed\n  };\n});\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3920,
        672
      ],
      "id": "3e0e9649-7316-4ef7-a0b0-0949f428dc57",
      "name": "JSON parsing"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4126ad34-525e-4e3b-9a38-6e24bf2a171c",
              "leftValue": "={{ $json.is_white_background}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4112,
        672
      ],
      "id": "dc544538-b750-4bba-8cff-00900a014c58",
      "name": "is background-removed image?"
    },
    {
      "parameters": {
        "jsCode": "// 모든 input items 가져오기\nconst items = $('get images API').all();\n\n\n// backgroundRemovedImagesBase64 배열 모두 모으기\n// 예: item.json.backgroundRemovedImagesBase64 = [\"data:image...\",\"data:image...\"]\nlet rawList = [];\n\nfor (const item of items) {\n  const arr = item.json.data.mainImagesBase64;\n  if (Array.isArray(arr)) {\n    rawList.push(...arr); // 배열 펼쳐서 추가\n  }\n}\n\n// base64만 추출하고, undefined/null/빈 문자열 제외\nconst base64List = rawList\n  .map(str => {\n    if (!str) return null;\n\n    // \"data:image/jpeg;base64,XXXX\" → \"XXXX\"만 추출\n    const parts = str.split(\",\");\n    return parts[1] ? parts[1] : parts[0]; \n  })\n  .filter(b => b); // falsy 제거\n\n// 결과를 \"값\", \"값\", \"값\" 형태로 출력 (마지막 콤마 없음)\nconst result = base64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); \n\nreturn [\n  {\n    json: {\n      backgroundRemovedImagesBase64: result\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4576,
        384
      ],
      "id": "f6c9af8d-d919-4ace-985d-24d6cbd740a9",
      "name": "make postData1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "41b3c35d-f2ab-49ce-a84a-d21d40e954bd",
              "leftValue": "={{ $('get images API').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": "={{ $input.all().length }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            },
            {
              "id": "66164562-f318-4543-ab8b-004a38bfd205",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4320,
        576
      ],
      "id": "8f1afeec-a6cc-4f65-9013-5b8eac9d6fbe",
      "name": "check true items count"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5f17c3e0-f3bc-47fa-98fa-a978f8c74fb7",
              "leftValue": "={{ $('get images API').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": "={{ $input.all().length }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4320,
        768
      ],
      "id": "875aca9a-f829-4df7-9631-efff22641ecf",
      "name": "check false items count"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://{{ $('When Executed by Another Workflow').all()[0].json.IP }}/api/products/update-background-removed",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"productNumber\": \"{{ $('When Executed by Another Workflow').all()[0].json.ProductID }}\",\n  \"backgroundRemovedImages\": [{{ $json.backgroundRemovedImagesBase64 }}]\n}\n\n\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4752,
        384
      ],
      "id": "ccb15550-58d3-40e6-b483-e27d05cb1972",
      "name": "post background-removed image"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "85adc80f-b990-4528-b94f-d338194f943d",
              "leftValue": "={{ $json.is_front_facing }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "36f22d9d-2efb-44b8-9cba-5436c218b9d8",
              "leftValue": "={{ $json.clothing_fully_visible}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4640,
        592
      ],
      "id": "d3790f9c-1877-4eea-87a3-8fdaf6579d07",
      "name": "can create background-removed images?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f35afcd9-47c3-41ce-9a3d-bdb33bd513ee",
              "leftValue": "={{ $('get images API').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": "={{ $input.all().length }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4928,
        576
      ],
      "id": "03f80007-fa79-4290-9869-d01cb1f3f885",
      "name": "check true items count 1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f35afcd9-47c3-41ce-9a3d-bdb33bd513ee",
              "leftValue": "={{ $('get images API').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": "={{ $input.all().length }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4928,
        816
      ],
      "id": "254b7d0b-2aee-4183-b3f6-ed1f5441506a",
      "name": "check false items count 1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6cf78535-14a3-4ea7-be07-3ee533242fe2",
              "leftValue": "={{ $('get images API').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5376,
        560
      ],
      "id": "2e5d335a-aa29-4fee-87ae-6f995cc1deec",
      "name": "check mainImages count"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]\n당신은 패션 제품 색상 비교에 특화된 전문 비전 모델입니다.\n입력된 두 장의 이미지를 분석하여 두 이미지 속 제품의 ‘색상(Color)’이 동일한지 여부만을 판단해야 합니다.\n\n📌 판단 기준 (Color-Only Judgment Rules)\n\n두 이미지의 제품이 다음 조건을 만족하면 \"same_color = true\",\n하나라도 다르면 \"same_color = false\" 로 판단합니다.\n\n✔ 동일하다고 판단되는 경우\n\n색상(Hue), 명도(Brightness), 채도(Saturation)가 촬영 환경 차이로 인한 미세한 변화 수준\n\n자연스러운 조명 변화(실내/실외, 밝기 차이 등)로 인한 오차\n\n그림자, 반사광으로 인한 부분적 색 변화\n\n❌ 다르다고 판단되는 경우\n\n주요 색상 자체가 다름 (예: 베이지 vs 브라운, 검정 vs 차콜 등)\n\n전체적으로 Hue 또는 Saturation이 다른 색 계열\n\n원단이 동일해 보이지 않을 정도의 강한 색조 차이\n\nAI가 자동 보정한 듯한 색 틀어짐\n\n🚫 비교 대상에서 제외되는 요소\n\n색상 판단만 수행하며 다음 요소는 판단에 포함하지 않습니다:\n\n실루엣, 핏, 길이, 버튼, 포켓, 패턴 등 디자인 변화\n\n이미지 해상도\n\n모델 또는 배경 차이\n\n전체 사진의 톤 스타일\n\n📤 출력 형식 (반드시 아래 형식으로만 출력)\n\n아래 JSON 하나만 출력합니다:\n\n{\n  \"same_color\": true | false,\n  \"reason\": \"짧고 명확한 색상 판단 근거\"\n}\n\n\n출력 외 다른 텍스트는 절대 생성하지 마십시오.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5632,
        576
      ],
      "id": "83a05d3f-c9ec-4eba-a6df-51690504609f",
      "name": "make pure color-judgment prompt"
    },
    {
      "parameters": {
        "jsCode": "const urls = $('get images API').all()[0].json.data.mainImagesBase64 || [];\nconst len = urls.length;\n\n// 사용할 인덱스 결정\nlet idx1, idx2;\n\nif (len === 2) {\n  idx1 = 0;\n  idx2 = 1;\n} else if (len >= 3) {\n  idx1 = 1;\n  idx2 = 2;\n} else {\n  // 이미지가 2개 미만이면 null 처리\n  return [\n    {\n      json: {\n        img1_base64: null,\n        img2_base64: null,\n        message: \"이미지가 2개 미만입니다.\"\n      }\n    }\n  ];\n}\n\n// Base64 순수값 추출 함수\nconst extract = (raw) => raw ? (raw.split(',')[1] || raw) : null;\n\nreturn [\n  {\n    json: {\n      img1_base64: extract(urls[idx1]),\n      img2_base64: extract(urls[idx2])\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5840,
        576
      ],
      "id": "ba002ebc-949f-4ccf-a9df-2da0b225aa31",
      "name": "make pure mainImages base64 data"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $('make pure color-judgment prompt').all()[0].json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.img1_base64 }}\"\n        }\n      },\n {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.img2_base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\"]\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6048,
        576
      ],
      "id": "9627f195-e13e-4e67-9363-e2ec5f50856d",
      "name": "color-judgment",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const res = $input.first().json;\n\n// text 추출\nlet raw = res.candidates?.[0]?.content?.parts?.[0]?.text ?? \"\";\n\n// 코드블록 제거\nraw = raw.replace(/```json|```/g, \"\").trim();\n\n// JSON 파싱\nlet parsed = null;\ntry {\n  parsed = JSON.parse(raw);\n} catch (e) {\n  parsed = { error: \"JSON 파싱 실패\", raw };\n}\n\nreturn [\n  {\n    json: parsed\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6256,
        576
      ],
      "id": "e9681a05-fdff-46cf-b0a4-4d126c236b68",
      "name": "JSON parsing1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6c5436a8-f43a-4c6c-95db-6ea953569747",
              "leftValue": "={{ $json.same_color }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6480,
        576
      ],
      "id": "03134776-b017-47d0-a12c-4b48961b0f45",
      "name": "is same color?"
    },
    {
      "parameters": {
        "jsCode": "const urls = $('get images API').all()[0].json.data.mainImagesBase64;\n\nreturn urls.map((u, index) => {\n  const pureBase64 = u.split(',')[1] || u; // \"data:image/...,\" 제거\n  return {\n    json: {\n      base64: pureBase64\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6944,
        592
      ],
      "id": "b7c80f73-3120-4dd2-8785-24b9c4c793e3",
      "name": "make pure mainImage base64 data"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://{{ $('When Executed by Another Workflow').all()[0].json.IP }}/api/products/update-background-removed",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"productNumber\": \"{{ $('When Executed by Another Workflow').all()[0].json.ProductID }}\",\n  \"backgroundRemovedImages\": [\n{{ $json.CutoutImage_Base64 }}\n  ]\n}\n\n\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7744,
        592
      ],
      "id": "34b59f8e-4f7c-461b-9068-b72b21cbd65e",
      "name": "post background-removed image1"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\noutputs = []\n\n# ==========================================================\n# 1) input 전체 반복 처리\n# ==========================================================\nfor item in _input.all():\n\n    # base64 위치 추출 (없으면 skip)\n    base64_input = item.json.get(\"candidates\", [])[0].get(\"content\", {}).get(\"parts\", [])[0].get(\"inlineData\", {}).get(\"data\")\n\n    if not base64_input:\n        outputs.append({\n            \"error\": \"base64 이미지 데이터를 찾을 수 없습니다.\",\n            \"original_item\": item.json\n        })\n        continue\n\n    # base64 decode\n    image_data = base64.b64decode(base64_input)\n\n    # ==========================================================\n    # 2) 이미지 로드\n    # ==========================================================\n    img = Image.open(BytesIO(image_data))\n\n    # ==========================================================\n    # 3) 비율 유지 + width 700px 리사이즈\n    # ==========================================================\n    target_width = 700\n    w, h = img.size\n    ratio = target_width / float(w)\n    target_height = int(h * ratio)\n\n    resized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n    # ==========================================================\n    # 4) 다시 base64로 변환\n    # ==========================================================\n    buffered = BytesIO()\n    resized_img.save(buffered, format=\"JPEG\")\n    output_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n    # ==========================================================\n    # 5) output 배열에 추가\n    # ==========================================================\n    outputs.append({\n        \"width\": target_width,\n        \"height\": target_height,\n        \"CutoutImage_Base64\": output_base64\n    })\n\n# ==========================================================\n# 6) n8n Output (items list 반환)\n# ==========================================================\nreturn outputs\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7328,
        592
      ],
      "id": "00b8513e-6640-4929-991b-d05c5ba29568",
      "name": "resize background-removed image"
    },
    {
      "parameters": {
        "jsCode": "// 모든 input items\nconst items = $input.all();\n\n// base64만 추출하고, undefined/null/빈 문자열 제외\nconst base64List = items\n  .map(i => i.json.CutoutImage_Base64)\n  .filter(b => b); // falsy 값 제거(undefined, null, \"\", 0)\n\n// ✨ 마지막 콤마 제거 버전 ✨\n// 각 값 앞뒤에 큰따옴표만 추가하고 join(\", \")으로 연결\nconst result = base64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); // 자동으로 마지막 콤마 제거됨\n\nreturn [\n  {\n    json: {\n      CutoutImage_Base64: result\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7520,
        592
      ],
      "id": "26be31eb-272f-4d75-b28f-4fe17621f4aa",
      "name": "sum background-removed image"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $('make pure background-removed prompt').all()[0].json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7136,
        592
      ],
      "id": "8fe36ba5-a82e-4c98-b8e4-2ed38c54f221",
      "name": "create background-removed image",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const category = $('get images API').all()[0].json.data.category;\n\n\nconst prompt = `\n🧠 [시스템 역할] — Garment Extraction AI\n\n당신의 작업은 입력 이미지에서 ** ${category} **로 지정된 의류만 정확하게 인식·분리한 뒤,\n사람·배경·소품을 100% 제거하고,\n순수 흰색(#FFFFFF) 배경 위에 해당 의류만 단독으로 재구성하는 것입니다.\n\n입력으로 제공되는 요소:\n\n이미지\n\n카테고리 (예: 상의-니트, 하의-팬츠, 아우터-코트 등)\n\n당신은 먼저 이미지 속에서 카테고리에 해당하는 의류를 정확히 찾아야 하며,\n해당 의류만을 대상으로 아래의 모든 규칙을 적용하여 결과 이미지를 생성해야 합니다.\n\n📌 1. 절대 변경 금지 규칙 (CRITICAL – 반드시 지킬 것)\n🎨 [색상 정확도 – ABSOLUTE COLOR PRESERVATION]\n\n색상은 단 1%라도 변경되면 안 됨.\n\n원본 의류의 색상, 명도, 채도, 톤, 텍스처 그대로 유지\n\n화이트밸런스 조정 금지\n\n대비/채도/톤/커브 조정 금지\n\n선명도·질감 보정 금지\n\n“더 예쁘게/더 선명하게” 같은 개선 작업 금지\n\n네이비는 네이비 그대로, 미세한 톤 변화도 허용되지 않음\n\n📌 2. 길이·비율 유지 규칙 (LENGTH & PROPORTION)\n\n의류의 실루엣, 길이, 폭, 형태는 절대로 수정 금지.\n\n총장, 어깨너비, 소매길이 등 원본 그대로\n\n늘리기, 줄이기, 비율 조정 금지\n\n형태 보정·라인 보정 금지\n\n더 깔끔하거나 균형 잡힌 모습으로 재구성하려는 시도 금지\n\n📌 3. 원본 충실도 규칙 (FAITHFUL REPRODUCTION)\n\n원본에 있는 디테일은 모두 보존\n\n존재하지 않는 디테일, 주름, 스티치 등을 생성 금지\n\n인체 착용으로 인해 생긴 부자연스러운 주름은 제거 가능\n\n의류 고유의 자연스러운 주름·질감은 유지\n\n📌 4. 제거해야 할 요소 (REMOVAL REQUIREMENTS)\n\n다음 요소는 100% 제거:\n\n👤 사람 관련 요소\n\n얼굴, 팔, 다리, 손, 머리카락, 피부\n\n인체 실루엣 흔적, 볼륨감\n\n착용으로 남는 몸매 윤곽\n\n🎒 액세서리·소품\n\n가방, 장신구, 머플러, 모자, 시계 등\n(단, 의류 자체 구성 요소는 제거 금지)\n\n🏠 배경\n\n실내/실외 배경\n\n바닥, 벽, 반사, 그림자\n\n바닥 그림자도 가능한 최소화 또는 제거\n\n📌 5. 출력 스타일 (GARMENT PRESENTATION)\n🔄 정렬 & 대칭\n\n좌우 완벽한 대칭\n\n카메라 정면 기준 정확한 수평·수직\n\n중심 지퍼/버튼 → 완전한 수직\n\n어깨 라인 → 정확히 수평\n\n소매 길이·폭 균일하게 정렬\n\n👕 형태\n\n플랫레이(flat-lay) 또는 고스트 마네킹 스타일\n\n자연스러운 형태 유지\n\n압축·납작함 금지\n\n모든 주름, 질감, 스티치, 디테일 최대 보존\n\n📌 6. 최종 출력 조건 (OUTPUT)\n\n배경: 완전한 흰색 #FFFFFF\n\n카테고리에 해당하는 의류만 화면 중앙 배치\n\n고해상도 & 선명한 가장자리\n\n그림자 최소화 또는 제거\n\n불필요한 요소 절대 포함 금지\n\n❌ 절대 금지 항목 (ABSOLUTE PROHIBITIONS)\n\n사람·얼굴·신체 잔여 생성 또는 남김\n\n배경 일부라도 남김\n\n카테고리에 해당하지 않는 제품 포함\n\n색상 변경(1%도 불가)\n\n비율/길이 왜곡\n\n실루엣 보정\n\n존재하지 않는 요소 생성\n\n마네킹/모델 생성\n\n\"더 깔끔하게\" 같은 품질 변경 시도\n\n제품을 자동으로 대칭 보정하기 위해 비율·형태 수정하는 행위\n\n📌 최종 작업 지시 (FINAL INSTRUCTION)\n\n입력된 **카테고리(category)**를 기준으로 이미지 속에서\n해당 카테고리의 의류 하나만 정확히 찾아 인식하시오.\n\n그 의류를:\n\n원본 색상 100% 유지\n\n원본 비율·형태 100% 유지\n\n인체/배경/소품 완전 제거\n\n플랫하게 정렬\n\n완전한 흰색(#FFFFFF) 배경 위에 자연스럽게 재구성\n\n하여 전문 쇼핑몰 누끼샷 수준으로 출력하시오.\n\n카테고리에 해당하지 않는 의류·소품은 절대 포함하면 안 된다.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6752,
        592
      ],
      "id": "da4059be-251e-40b8-bea1-44eac0916d65",
      "name": "make pure background-removed prompt"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6cf78535-14a3-4ea7-be07-3ee533242fe2",
              "leftValue": "={{ $('get images API').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5344,
        800
      ],
      "id": "9f981c42-7c44-46b8-86c8-bc86b96d7765",
      "name": "check mainImages count1"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]\n당신은 패션 제품 색상 비교에 특화된 전문 비전 모델입니다.\n입력된 두 장의 이미지를 분석하여 두 이미지 속 제품의 ‘색상(Color)’이 동일한지 여부만을 판단해야 합니다.\n\n📌 판단 기준 (Color-Only Judgment Rules)\n\n두 이미지의 제품이 다음 조건을 만족하면 \"same_color = true\",\n하나라도 다르면 \"same_color = false\" 로 판단합니다.\n\n✔ 동일하다고 판단되는 경우\n\n색상(Hue), 명도(Brightness), 채도(Saturation)가 촬영 환경 차이로 인한 미세한 변화 수준\n\n자연스러운 조명 변화(실내/실외, 밝기 차이 등)로 인한 오차\n\n그림자, 반사광으로 인한 부분적 색 변화\n\n❌ 다르다고 판단되는 경우\n\n주요 색상 자체가 다름 (예: 베이지 vs 브라운, 검정 vs 차콜 등)\n\n전체적으로 Hue 또는 Saturation이 다른 색 계열\n\n원단이 동일해 보이지 않을 정도의 강한 색조 차이\n\nAI가 자동 보정한 듯한 색 틀어짐\n\n🚫 비교 대상에서 제외되는 요소\n\n색상 판단만 수행하며 다음 요소는 판단에 포함하지 않습니다:\n\n실루엣, 핏, 길이, 버튼, 포켓, 패턴 등 디자인 변화\n\n이미지 해상도\n\n모델 또는 배경 차이\n\n전체 사진의 톤 스타일\n\n📤 출력 형식 (반드시 아래 형식으로만 출력)\n\n아래 JSON 하나만 출력합니다:\n\n{\n  \"same_color\": true | false,\n  \"reason\": \"짧고 명확한 색상 판단 근거\"\n}\n\n\n출력 외 다른 텍스트는 절대 생성하지 마십시오.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5616,
        816
      ],
      "id": "768f5316-e27f-4df1-a516-1187a5b30e7e",
      "name": "make pure color-judgment prompt1"
    },
    {
      "parameters": {
        "jsCode": "const urls = $('get images API').all()[0].json.data.mainImagesBase64 || [];\nconst len = urls.length;\n\n// 사용할 인덱스 결정\nlet idx1, idx2;\n\nif (len === 2) {\n  idx1 = 0;\n  idx2 = 1;\n} else if (len >= 3) {\n  idx1 = 1;\n  idx2 = 2;\n} else {\n  // 이미지가 2개 미만이면 null 처리\n  return [\n    {\n      json: {\n        img1_base64: null,\n        img2_base64: null,\n        message: \"이미지가 2개 미만입니다.\"\n      }\n    }\n  ];\n}\n\n// Base64 순수값 추출 함수\nconst extract = (raw) => raw ? (raw.split(',')[1] || raw) : null;\n\nreturn [\n  {\n    json: {\n      img1_base64: extract(urls[idx1]),\n      img2_base64: extract(urls[idx2])\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5824,
        816
      ],
      "id": "80f00e30-17b1-4e02-ae9a-9d4d2504b797",
      "name": "make pure mainImages base64 data1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $('make pure color-judgment prompt').all()[0].json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.img1_base64 }}\"\n        }\n      },\n {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.img2_base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\"]\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6032,
        816
      ],
      "id": "5b48aa07-88df-4ed6-864a-c5e2f8f155b3",
      "name": "color-judgment1",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const res = $input.first().json;\n\n// text 추출\nlet raw = res.candidates?.[0]?.content?.parts?.[0]?.text ?? \"\";\n\n// 코드블록 제거\nraw = raw.replace(/```json|```/g, \"\").trim();\n\n// JSON 파싱\nlet parsed = null;\ntry {\n  parsed = JSON.parse(raw);\n} catch (e) {\n  parsed = { error: \"JSON 파싱 실패\", raw };\n}\n\nreturn [\n  {\n    json: parsed\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6240,
        816
      ],
      "id": "b3b97793-cb3e-4d2b-bd40-bc4cbc2e6b00",
      "name": "JSON parsing2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6c5436a8-f43a-4c6c-95db-6ea953569747",
              "leftValue": "={{ $json.same_color }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6432,
        816
      ],
      "id": "e952f9df-3f62-4d54-9669-8346f34bf22f",
      "name": "is same color?1"
    },
    {
      "parameters": {
        "jsCode": "const urls = $('get images API').all()[0].json.data.mainImagesBase64;\n\nreturn urls.map((u, index) => {\n  const pureBase64 = u.split(',')[1] || u; // \"data:image/...,\" 제거\n  return {\n    json: {\n      base64: pureBase64\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6960,
        832
      ],
      "id": "cafe71f8-f9d9-4aa7-b740-499bb8f6b0c5",
      "name": "make pure mainImage base64 data1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $('make pure background-removed prompt1').all()[0].json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('resize thumbnail').all()[0].json.ThumbnailImage_Base64 }}\"\n        }\n      },\n {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7136,
        832
      ],
      "id": "b51f7ead-084c-4ecd-98d8-6fd6b7ffe63c",
      "name": "create background-removed image1",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\noutputs = []\n\n# ==========================================================\n# 1) input 전체 반복 처리\n# ==========================================================\nfor item in _input.all():\n\n    # base64 위치 추출 (없으면 skip)\n    base64_input = item.json.get(\"candidates\", [])[0].get(\"content\", {}).get(\"parts\", [])[0].get(\"inlineData\", {}).get(\"data\")\n\n    if not base64_input:\n        outputs.append({\n            \"error\": \"base64 이미지 데이터를 찾을 수 없습니다.\",\n            \"original_item\": item.json\n        })\n        continue\n\n    # base64 decode\n    image_data = base64.b64decode(base64_input)\n\n    # ==========================================================\n    # 2) 이미지 로드\n    # ==========================================================\n    img = Image.open(BytesIO(image_data))\n\n    # ==========================================================\n    # 3) 비율 유지 + width 700px 리사이즈\n    # ==========================================================\n    target_width = 700\n    w, h = img.size\n    ratio = target_width / float(w)\n    target_height = int(h * ratio)\n\n    resized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n    # ==========================================================\n    # 4) 다시 base64로 변환\n    # ==========================================================\n    buffered = BytesIO()\n    resized_img.save(buffered, format=\"JPEG\")\n    output_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n    # ==========================================================\n    # 5) output 배열에 추가\n    # ==========================================================\n    outputs.append({\n        \"width\": target_width,\n        \"height\": target_height,\n        \"CutoutImage_Base64\": output_base64\n    })\n\n# ==========================================================\n# 6) n8n Output (items list 반환)\n# ==========================================================\nreturn outputs\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7328,
        832
      ],
      "id": "36c9fb8e-be2e-48dc-879b-d7aa98ae967a",
      "name": "resize background-removed image1"
    },
    {
      "parameters": {
        "jsCode": "// 모든 input items\nconst items = $input.all();\n\n// base64만 추출하고, undefined/null/빈 문자열 제외\nconst base64List = items\n  .map(i => i.json.CutoutImage_Base64)\n  .filter(b => b); // falsy 값 제거(undefined, null, \"\", 0)\n\n// ✨ 마지막 콤마 제거 버전 ✨\n// 각 값 앞뒤에 큰따옴표만 추가하고 join(\", \")으로 연결\nconst result = base64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); // 자동으로 마지막 콤마 제거됨\n\nreturn [\n  {\n    json: {\n      CutoutImage_Base64: result\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7520,
        832
      ],
      "id": "8669ef2d-02ef-43c0-9c00-f34992e6597e",
      "name": "sum background-removed image1"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n당신은 쇼핑몰 상세페이지(세로형) 이미지를 분석하는 전문 비전 분석 모델입니다.\n아래 규칙에 따라 이미지에서 **오직 정보영역(info_section)**만 정확하게 감지하고,\n그 픽셀 좌표(x, y, width, height)와 전체 이미지 크기를 반환하십시오.\n===========================================================\n:경고: 중요: 이미지 크기 측정 원칙\n반환하는 ai_processed_size는 **실제 이미지의 픽셀 크기**여야 합니다.\n- 이미지 뷰어에서 보이는 크기가 아닌, 원본 파일의 실제 픽셀 해상도 기준\n- 세로로 긴 상세페이지의 경우 width는 보통 작고(100~1000px), height가 매우 큼(1000~10000px)\n===========================================================\n:다트: 핵심 원칙 (최우선 적용)\ninfo_section은 **텍스트 + 표 + 도식화**로 구성된 정보 영역이다.\n**실사 사진 또는 실사 사진의 배경색이 1px이라도 포함되면 안 된다.**\n:흰색_확인_표시: 허용:\n- 순수 텍스트 / 표(table)\n- 도식화 (옷 실루엣 + 치수선 일러스트)\n- 아이콘, 심볼\n- **흰색(#FFFFFF) 또는 완전한 단색 배경**\n:출입금지: 제외 (실사 사진 및 관련 요소):\n- 원단/소재 클로즈업 사진\n- 제품 착용컷 / 모델 사진\n- 제품 단독 사진\n- 디테일 확대 사진\n- **실사 사진의 일부가 잘린 영역 (베이지, 그레이 등 제품/배경 색상이 보이는 부분)**\n===========================================================\n:압정: info_section 시작점 감지 규칙 (필수 적용)\n:다트: **특수 규칙 – \"Size Information\" 텍스트 기준 처리**\nSTEP 1) 이미지 내에서 \"Size Information\" 텍스트를 찾는다\nSTEP 2) 해당 텍스트의 상단 y좌표를 확인한다\nSTEP 3) **배경색 검증 (필수)**\n- \"Size Information\" 텍스트 바로 위 영역의 배경색을 확인\n- 만약 흰색이 아닌 다른 색상(베이지, 그레이, 제품 색상 등)이 보이면:\n → 해당 색상 영역이 완전히 끝나는 지점까지 y좌표를 아래로 이동\n- info_section은 **반드시 흰색 배경에서 시작**해야 함\nSTEP 4) 최종 시작점 결정\n- 시작점(y) = 흰색 배경이 시작되는 지점 (실사 사진/배경색 완전 제외)\n===========================================================\n:압정: info_section 일반 감지 규칙 (\"Size Information\" 텍스트가 없는 경우)\nSTEP 1) **이미지 맨 아래에서 위로 스캔**\n- 하단부터 올라가며 텍스트/표/도식화 영역 확인\nSTEP 2) **실사 사진 또는 비-흰색 배경을 만나면 스캔 중지**\n- 위로 올라가다가 제품사진 또는 컬러 배경을 발견하면 멈춤\n- 해당 영역의 **가장 아래 y좌표(하단 끝)**를 기록\nSTEP 3) **info_section 시작점 계산**\n- 시작점(y) = 실사 영역 하단 y좌표 + 여백\n- 흰색 배경이 확실히 시작되는 지점\nSTEP 4) **info_section 종료점**\n- 종료점 = 이미지 전체 height\n===========================================================\n:압정: 실사 사진 vs 정보 영역 구분 기준\n실사 사진 영역 (:출입금지: 제외):\n- 카메라로 촬영된 실제 질감\n- 원단/제품의 음영·입체감\n- 사실적인 색감, 주름, 그림자\n- **베이지, 그레이, 크림색 등 촬영 배경색**\n- **제품 색상이 일부라도 보이는 영역**\n정보 영역 (:흰색_확인_표시: 허용):\n- 선형 일러스트 (치수 도식화)\n- 치수 안내선, 숫자·단위\n- 단순 외곽선, 평면적 그래픽\n- **흰색 배경 위의 텍스트/표**\n===========================================================\n:압정: 최종 검증 체크리스트\n출력 전 반드시 확인:\n☐ 시작점(y) 위치에 실사 사진이 없는가?\n☐ 시작점(y) 위치의 배경이 흰색인가?\n☐ 시작점(y) ~ y+50px 구간에 베이지/그레이 등 컬러가 없는가?\n☐ ai_processed_size가 실제 이미지 픽셀 크기와 일치하는가?\n하나라도 실패하면 → 시작점(y)을 아래로 조정\n===========================================================\n:압정: 출력 형식 (JSON만 출력)\n{\n \"ai_processed_size\": {\n  \"width\": number,  // 실제 이미지 픽셀 너비\n  \"height\": number  // 실제 이미지 픽셀 높이\n },\n \"sections\": {\n  \"info_section\": {\n   \"x\": number,\n   \"y\": number,   // 흰색 배경 시작점\n   \"width\": number,\n   \"height\": number\n  } | null\n }\n}\n===========================================================\n:경고: 최종 강조\n1. 정보영역에 실사 사진이 절대 포함되면 안 됨\n2. 실사 사진의 배경색(베이지, 그레이 등)도 실사 영역으로 간주\n3. info_section은 반드시 **흰색 배경**에서 시작\n4. 애매하면 시작점을 아래로 (보수적으로 판단)\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3424,
        16
      ],
      "id": "4daba3bb-5691-4f3a-b34d-d1640d8e26e7",
      "name": "make pure info-section judgment prompt1"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n당신은 쇼핑몰 상세페이지(세로형) 이미지에서 **정보영역(info_section)**의 시작점을 찾는 비전 분석 모델입니다.\n\n═══════════════════════════════════════════════════════════\n📌 정보영역 정의\n═══════════════════════════════════════════════════════════\n정보영역 = 텍스트 기반의 제품 상세정보가 시작되는 지점부터 이미지 끝까지\n\n포함 대상:\n- Color View, Fabric View Point Details, Size Information, Product Information 등 정보 헤더\n- 사이즈 표, 제품 스펙 표\n- 도식화(선화 형태의 치수 안내 일러스트)\n- Notice, 배송안내, 교환/반품, 주의사항 등 텍스트 영역\n\n제외 대상 (절대 포함 금지):\n- 실사 제품 사진, 모델 컷, 착용샷\n- 원단/디테일 클로즈업 사진\n- 배경이 있는 제품 촬영 이미지\n\n═══════════════════════════════════════════════════════════\n🎯 시작점(y) 결정 규칙 (우선순위)\n═══════════════════════════════════════════════════════════\n\n[1순위] 정보 헤더 텍스트 검색\n아래 텍스트 중 가장 먼저(위쪽에) 나타나는 것을 찾는다:\n- \"Fabric View\" / \"Fabric\" / \"원단 정보\" /\n- \"Color View\" / \"Color Info\" / \"색상 정보\"\n- \"Point Details\" / \"Point Detail\"\n- \"Size Information\" / \"Size Info\" / \"사이즈 정보\"\n- \"Product Information\" / \"Product Info\" / \"제품 정보\"\n- \"Detail Information\" / \"상세 정보\"\n\n완전 포함 원칙:\n텍스트의 첫 글자가 절대 잘리지 않도록 보수적으로 넉넉하게 잡을 것\n시작점 설정 방식:\n\"텍스트가 시작되는 지점\"이 아니라 **\"텍스트 영역 바로 위 여백까지 포함한 지점\"**을 시작점으로 인식\n→ 해당 텍스트의 상단 경계에서 여백이 살짝 보이는 부분의 y값을 시작점으로 설정\n→ 절대로 옷, 제품사진이 포함되면 안됨.\n\n[2순위] 정보 헤더가 없는 경우\n사이즈 표(테이블) 또는 스펙 표의 상단을 찾는다\n→ 표 상단에서 위로 30px 여백을 포함한 y값을 시작점으로 설정\n\n[3순위] 위 요소가 모두 없는 경우\n마지막 실사 사진이 끝나는 지점을 찾는다\n→ 사진 하단 + 30px을 시작점으로 설정\n\n═══════════════════════════════════════════════════════════\n⚠️ 검증 체크리스트 (필수 확인)\n═══════════════════════════════════════════════════════════\n□ 시작점(y) 아래쪽 20px 내에 실사 사진이 없는가?\n\n→ 실사 사진이 있을경우 y값을 실사사진 하단 경계로 이동.\n\n═══════════════════════════════════════════════════════════\n📤 출력 형식\n═══════════════════════════════════════════════════════════\n반드시 아래 JSON 형식만 출력하세요. 설명이나 추가 텍스트 금지.\n\n{\n  \"ai_processed_size\": {\n    \"width\": [이미지 전체 너비],\n    \"height\": [이미지 전체 높이]\n  },\n  \"sections\": {\n    \"info_section\": {\n      \"x\": 0,\n      \"y\": [정보영역 시작 y좌표],\n      \"width\": [이미지 전체 너비],\n      \"height\": [이미지 높이 - 시작 y좌표]\n    }\n  }\n}\n\n═══════════════════════════════════════════════════════════\n📝 계산 공식\n═══════════════════════════════════════════════════════════\n- info_section.x = 0 (항상 좌측 끝에서 시작)\n- info_section.width = ai_processed_size.width (전체 너비)\n- info_section.height = ai_processed_size.height - info_section.y\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3632,
        16
      ],
      "id": "67c792bf-8230-4620-b113-5ebf8fee3f07",
      "name": "make pure info-section judgment prompt2"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "\nimport base64\nfrom PIL import Image\nfrom io import BytesIO\n\n# 인풋 이미지 base64\nraw_b64 = _('make pure base64').first().json.SubImageBase64\npure_b64 = raw_b64.split(\",\")[-1]\n\nimg_data = base64.b64decode(pure_b64)\nimg = Image.open(BytesIO(img_data))\n\norig_w, orig_h = img.size\n\ntarget_h = 8000\ntarget_w = int(orig_w * (target_h / orig_h))\n\nreturn {\n    \"original_width\": orig_w,\n    \"original_height\": orig_h,\n    \"resize_width\": target_w,\n    \"resize_height\": target_h,\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3232,
        16
      ],
      "id": "5e663538-5643-466e-8ce5-c44233132a07",
      "name": "caculate subimage size"
    },
    {
      "parameters": {
        "operation": "resize",
        "dataPropertyName": "Image",
        "width": "={{ $('caculate subimage size').all()[0].json.resize_width }}",
        "height": "={{ $('caculate subimage size').all()[0].json.resize_height }}",
        "options": {}
      },
      "type": "n8n-nodes-base.editImage",
      "typeVersion": 1,
      "position": [
        4272,
        16
      ],
      "id": "a6f7fab3-3379-4a07-9111-920ea39efa22",
      "name": "resize subImage"
    },
    {
      "parameters": {
        "resource": "image",
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-5-20250929",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-5-20250929"
        },
        "text": "={{ $('make pure info-section judgment prompt1').all()[0].json.cleanedPrompt }}",
        "inputType": "binary",
        "binaryPropertyName": "Image",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        4448,
        16
      ],
      "id": "5a57e775-7cbf-46f4-a207-e5e1f40eb58e",
      "name": "Analyze subImage",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 5000,
      "credentials": {
        "anthropicApi": {
          "id": "s53gMH1GWKtYEmUN",
          "name": "Claude API_1"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =======================================================\n// 1) AI output (TEXT 형태) 가져오기\n// =======================================================\nlet text = \"\";\n\n// 형태 1: { content: [ { type: \"text\", text: \"...\" } ] }\nif ($json.content && Array.isArray($json.content) && $json.content[0]?.text) {\n  text = $json.content[0].text;\n}\n\n// 형태 2: { content: [ { parts: [ { text: \"...\" } ] } ] }\nif (!text && $json.content?.[0]?.parts?.[0]?.text) {\n  text = $json.content[0].parts[0].text;\n}\n\n// 형태 3: 일반 text\nif (!text && $json.text) {\n  text = $json.text;\n}\n\nif (!text) {\n  throw new Error(\"AI로부터 받은 텍스트를 찾을 수 없습니다.\");\n}\n\n// =======================================================\n// 2) ```json ... ``` 안의 JSON만 추출\n// =======================================================\nconst jsonMatch = text.match(/```json([\\s\\S]*?)```/);\n\nif (!jsonMatch) {\n  throw new Error(\"텍스트 안에서 JSON 블록을 찾을 수 없습니다.\");\n}\n\nlet jsonString = jsonMatch[1].trim();\n\n// =======================================================\n// 3) JSON 문자열을 실제 객체로 변환\n// =======================================================\nlet item;\ntry {\n  item = JSON.parse(jsonString);\n} catch (e) {\n  throw new Error(\"JSON 파싱 실패: \" + e.message);\n}\n\n// =======================================================\n// 4) 원본 이미지 크기 (Attach Base65 노드)에서 가져오기\n// =======================================================\n\nconst W_org = $('caculate subimage size').first().json.resize_width;\nconst H_org = $('caculate subimage size').first().json.resize_height;\n\nif (!W_org || !H_org) {\n  throw new Error(\"원본 이미지 크기(resize_width, resize_height)를 찾을 수 없습니다.\");\n}\n\n// =======================================================\n// 5) AI가 본 이미지 크기(ai_processed_size)\n// =======================================================\nconst ai = item.ai_processed_size;\n\nif (!ai || !ai.width || !ai.height) {\n  throw new Error(\"ai_processed_size.width/height가 존재하지 않습니다.\");\n}\n\nconst W_ai = ai.width;\nconst H_ai = ai.height;\n\n// =======================================================\n// 6) 스케일링 함수\n// =======================================================\nfunction scale(value, original, ai) {\n  return Math.round(value * (original / ai));\n}\n\n// =======================================================\n// 7) 섹션 좌표를 원본 스케일 기준으로 변환\n// =======================================================\nconst output = [];\n\nfor (const key in item.sections) {\n  const sec = item.sections[key];\n\n  const scaled = {\n    section_name: key,\n    x: scale(sec.x, W_org, W_ai),\n    y: scale(sec.y, H_org, H_ai),\n    width: scale(sec.width, W_org, W_ai),\n    height: scale(sec.height, H_org, H_ai)\n  };\n\n  output.push({ json: scaled });\n}\n\n// =======================================================\n// 8) n8n의 Code node는 배열을 반환해야 함\n// =======================================================\nreturn output;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4640,
        16
      ],
      "id": "8016fa99-e08e-497a-8cd4-eb9a425c1929",
      "name": "JSON parsing3"
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    json: {\n      base64: $('make pure base64').first().json.SubImageBase64\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4864,
        16
      ],
      "id": "97cdf0e3-7249-4c5d-9bf8-1b6c245c670a",
      "name": "get subImageBase"
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    json: {\n      base64: $('make pure base64').first().json.SubImageBase64\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3904,
        16
      ],
      "id": "f5cdae49-7e81-43b3-b290-25c63b26c50d",
      "name": "get subImageBase1"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base64",
        "binaryPropertyName": "Image",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        5056,
        16
      ],
      "id": "bea08631-0001-42a6-8d21-468d6ffb93ce",
      "name": "Convert Base64 To File1"
    },
    {
      "parameters": {
        "operation": "crop",
        "dataPropertyName": "Image",
        "width": "={{ $('JSON parsing3').all()[0].json.width }}",
        "height": "={{ $('JSON parsing3').all()[0].json.height }}",
        "positionX": "=0",
        "positionY": "={{ $('JSON parsing3').all()[0].json.y }}",
        "options": {}
      },
      "type": "n8n-nodes-base.editImage",
      "typeVersion": 1,
      "position": [
        5424,
        16
      ],
      "id": "4888898b-33d8-4f5a-b8f1-4b1639bd4384",
      "name": "Edit Image"
    },
    {
      "parameters": {
        "resource": "image",
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-5-20250929",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-5-20250929"
        },
        "text": "={{ $('make pure info-section judgment prompt2').all()[0].json.cleanedPrompt }}",
        "inputType": "binary",
        "binaryPropertyName": "Image",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        5616,
        16
      ],
      "id": "c0ce506d-0f25-4dfb-b91e-e962335829da",
      "name": "Analyze subImage1",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "anthropicApi": {
          "id": "p6BLBZwDjHyrH8aE",
          "name": "Claude API_2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =======================================================\n// 1) AI output (TEXT 형태) 가져오기\n// =======================================================\nlet text = \"\";\n\n// 형태 1: { content: [ { type: \"text\", text: \"...\" } ] }\nif ($json.content && Array.isArray($json.content) && $json.content[0]?.text) {\n  text = $json.content[0].text;\n}\n\n// 형태 2: { content: [ { parts: [ { text: \"...\" } ] } ] }\nif (!text && $json.content?.[0]?.parts?.[0]?.text) {\n  text = $json.content[0].parts[0].text;\n}\n\n// 형태 3: 일반 text\nif (!text && $json.text) {\n  text = $json.text;\n}\n\nif (!text) {\n  throw new Error(\"AI로부터 받은 텍스트를 찾을 수 없습니다.\");\n}\n\n// =======================================================\n// 2) ```json ... ``` 안의 JSON만 추출\n// =======================================================\nconst jsonMatch = text.match(/```json([\\s\\S]*?)```/);\n\nif (!jsonMatch) {\n  throw new Error(\"텍스트 안에서 JSON 블록을 찾을 수 없습니다.\");\n}\n\nlet jsonString = jsonMatch[1].trim();\n\n// =======================================================\n// 3) JSON 문자열을 실제 객체로 변환\n// =======================================================\nlet item;\ntry {\n  item = JSON.parse(jsonString);\n} catch (e) {\n  throw new Error(\"JSON 파싱 실패: \" + e.message);\n}\n\n// =======================================================\n// 4) 원본 이미지 크기 (Attach Base65 노드)에서 가져오기\n// =======================================================\n\nconst W_org = $('JSON parsing3').all()[0].json.width;\nconst H_org = $('JSON parsing3').all()[0].json.height;\n\nif (!W_org || !H_org) {\n  throw new Error(\"원본 이미지 크기(resize_width, resize_height)를 찾을 수 없습니다.\");\n}\n\n// =======================================================\n// 5) AI가 본 이미지 크기(ai_processed_size)\n// =======================================================\nconst ai = item.ai_processed_size;\n\nif (!ai || !ai.width || !ai.height) {\n  throw new Error(\"ai_processed_size.width/height가 존재하지 않습니다.\");\n}\n\nconst W_ai = ai.width;\nconst H_ai = ai.height;\n\n// =======================================================\n// 6) 스케일링 함수\n// =======================================================\nfunction scale(value, original, ai) {\n  return Math.round(value * (original / ai));\n}\n\n// =======================================================\n// 7) 섹션 좌표를 원본 스케일 기준으로 변환\n// =======================================================\nconst output = [];\n\nfor (const key in item.sections) {\n  const sec = item.sections[key];\n\n  const scaled = {\n    section_name: key,\n    x: scale(sec.x, W_org, W_ai),\n    y: scale(sec.y, H_org, H_ai),\n    width: scale(sec.width, W_org, W_ai),\n    height: scale(sec.height, H_org, H_ai)\n  };\n\n  output.push({ json: scaled });\n}\n\n// =======================================================\n// 8) n8n의 Code node는 배열을 반환해야 함\n// =======================================================\nreturn output;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5808,
        16
      ],
      "id": "82bfa87a-9ab8-474c-9516-4c69303e3da1",
      "name": "JSON parsing4"
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    json: {\n      base64: $('make pure base64').first().json.SubImageBase64\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6000,
        16
      ],
      "id": "bb213902-cce0-47e1-8273-40c57303bd7c",
      "name": "get subImageBase2"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base64",
        "binaryPropertyName": "Image",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        6176,
        16
      ],
      "id": "42bee031-6e70-4255-ac09-4e15bd149eb4",
      "name": "Convert Base64 To File2"
    },
    {
      "parameters": {
        "operation": "resize",
        "dataPropertyName": "Image",
        "width": "={{ $('caculate subimage size').all()[0].json.resize_width }}",
        "height": "={{ $('caculate subimage size').all()[0].json.resize_height }}",
        "options": {}
      },
      "type": "n8n-nodes-base.editImage",
      "typeVersion": 1,
      "position": [
        6352,
        16
      ],
      "id": "032a7c1f-2abc-423c-b87b-da7733097075",
      "name": "Resize Image1"
    },
    {
      "parameters": {
        "operation": "crop",
        "dataPropertyName": "Image",
        "width": "={{ $('JSON parsing4').all()[0].json.width }}",
        "height": "={{ $('JSON parsing4').all()[0].json.height }}",
        "positionX": "=0",
        "positionY": "={{ 8000 - $('JSON parsing4').all()[0].json.height }}",
        "options": {}
      },
      "type": "n8n-nodes-base.editImage",
      "typeVersion": 1,
      "position": [
        6528,
        16
      ],
      "id": "3d4f6c3b-292b-48bb-bade-8be59f078eec",
      "name": "Edit Image1"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom PIL import Image\nfrom io import BytesIO\n\n# base64 불러오기\nb64 = _input.first().json.Info_Image\nimg_data = base64.b64decode(b64.split(\",\")[-1])\nimg = Image.open(BytesIO(img_data))\n\n# RGBA → RGB 변환\nif img.mode in (\"RGBA\", \"LA\"):\n    img = img.convert(\"RGB\")\n\n# 리사이즈 (예시)\ntarget_w = 700\norig_w, orig_h = img.size\nratio = target_w / orig_w\ntarget_h = int(orig_h * ratio)\nimg = img.resize((target_w, target_h), Image.LANCZOS)\n\n# JPEG로 저장\nbuffer = BytesIO()\nimg.save(buffer, format=\"JPEG\", quality=90)\nout_b64 = base64.b64encode(buffer.getvalue()).decode()\n\nreturn {\n    \"resized_image\": \"data:image/jpeg;base64,\" + out_b64\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6912,
        16
      ],
      "id": "051d553f-0aee-4ed2-a02d-e82151a7a035",
      "name": "resize info-section image"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://{{ $('When Executed by Another Workflow').all()[0].json.IP }}/api/products/update-ai-images",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"productNumber\": \n    \"{{ $('When Executed by Another Workflow').all()[0].json.ProductID }}\",\n  \"AIThumbNailImage\": \n    \"{{ $('resize thumbnail').all()[0].json.ThumbnailImage_Base64 }}\",\n  \"AIMainImageUrls\": [\n    {{ $('merge model-cut images').all()[0].json.ModelImage_Base64 }}\n  ],\n  \"AISubImageUrls\": [ \n    {{ $('merge model-cut images').all()[0].json.ModelImage_Base64 }},\n    \"{{ $('resize info-section image').all()[0].json.resized_image }}\" \n  ],\n  \"AIDetailImageUrls\": [ \n    \"{{ $('resize info-section image').all()[0].json.resized_image }}\" \n  ]\n}\n\n\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7104,
        16
      ],
      "id": "f6f08a66-a0be-498a-a0c6-28df0325fa2a",
      "name": "post image API"
    },
    {
      "parameters": {
        "content": "## Create all image",
        "height": 80,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -992,
        -112
      ],
      "id": "2ab515af-d53c-4a27-bf23-e404e2ec73dd",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "### Create thumbnail image",
        "height": 80,
        "width": 224,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1024,
        -96
      ],
      "id": "96b9ed9f-0c7b-4fec-b58f-c3e5412bc3d1",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "### Create model-cut image",
        "height": 80,
        "width": 224,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1648,
        -576
      ],
      "id": "425623aa-f705-4fab-9708-5dbf477e8661",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "### Create Detail image",
        "height": 80,
        "width": 224,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        3232,
        -96
      ],
      "id": "726a723d-f647-4dcd-9b69-80cf1ef289b3",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "### Create background-removed image\n",
        "height": 80,
        "width": 336,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        3200,
        544
      ],
      "id": "fa129b88-3046-40ff-a6b5-85c1457e8c9e",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=당신은 패션 제품 분석에 특화된 전문 비전 감지 AI입니다.\n당신의 역할은 첨부된 제품 사진이 새로운 이미지 생성에 적합한지,\n즉 제품이 사람의 신체나 다른 사물에 의해 가려져 있지 않은지를\n정확하게 판단하는 것입니다.\n\n당신은 절대 이미지를 생성하거나 수정하지 않습니다.\n오직 “판단/평가”만 수행합니다.\n\n────────────────────────────\n[입력 정보]\n\n제품 카테고리: {{ $('get images API').all()[0].json.data.category }}\n\n────────────────────────────\n[AI의 주요 임무]\n\n사진 속 제품이 아래 기준에 따라 가려져 있는지를 판단하시오.\n단, 전체적인 실루엣과 핵심 디테일을 확인할 수 있다면\n경미한 가장자리 잘림(밑단 5~10% 정도, 프레임 크롭 등)은 허용합니다.\n\n제품 전체가 온전히 보이는가?\n\n카테고리 기준 중요한 구성 요소가 모두 식별 가능해야 합니다.\n\n전체 윤곽과 주요 디테일을 판단할 수 있다면 약간의 컷팅은 괜찮음.\n\n그러나 중요한 부분(어깨, 암홀, 허리라인, 카라, 주머니 여부 등)이 보이지 않으면 “가려짐(true)”.\n\n신체(머리·팔·손·다리 등)에 의해 제품 일부가 가려져 있는가?\n\n팔이나 손이 제품을 살짝 스치거나 일부 라인을 가리는 정도는 허용.\n\n그러나 제품의 실루엣 판단을 어렵게 만들 정도로 가렸다면 “가려짐(true)\".\n\n배경 사물·소품·텍스트·그림자 등에 의해 제품이 가려져 있는가?\n\n제품의 주요 형태가 식별 가능하면 경미한 간섭은 허용.\n\n핵심 디테일이 가려지면 \"true\".\n\n카메라각도로 인해 중요한 디테일이 보이지 않는가?\n\n측면 사진이어도 전체 실루엣과 주요 디테일을 식별할 수 있다면 허용.\n\n그러나 전면·측면 등 필수 관찰 요소가 확인되지 않으면 \"true\".\n\n─────\n[카테고리별 중요 노출 요소 — 판단 시 반드시 고려]\n\n상의(자켓, 티셔츠, 니트 등): 어깨선, 암홀, 몸판 전체 실루엣, 소매, 밑단, 주머니 여부\n\n하의(바지/스커트): 허리 라인, 실루엣 전체, 밑단\n\n원피스: 어깨~밑단 전체 실루엣\n\n아우터: 카라/라펠, 어깨선, 소매 전체, 몸판 전체, 주머니 여부\n\n────────────────────────────\n[출력 형식(JSON만 반환)]\n\n{\n  \"is_occluded\": true | false,\n  \"reason\": \"왜 이렇게 판단했는지 상세 설명\"\n}\n\n\ntrue → 제품이 가려져 있어 새 이미지 생성에 부적합\n\nfalse → 제품이 온전히 보이며 생성 가능",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -48,
        16
      ],
      "id": "c9c36778-68c9-48c4-8aac-63ac7cc515ab",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -48,
        192
      ],
      "id": "84c69560-cb24-4784-93ca-2b75bca8f597",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "e7t27ilShPQLOWu7",
          "name": "Google Geminie Soonicron API"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('get images API').all()[0].json.data.category }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        48,
        192
      ],
      "id": "c6597c3f-779e-4e1e-b020-e4f4e660194b",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "ThumbNailImageBase64",
        "binaryPropertyName": "Image",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -208,
        16
      ],
      "id": "e39465e1-a32b-48d3-a9b4-136823136ab9",
      "name": "convert imageFIle1"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// 각 아이템을 개별적으로 처리하여 결과 아이템 배열 생성\nconst results = items.map(i => {\n  const raw = i.json.output;\n\n  // ```json ``` 블록 제거\n  const cleaned = String(raw ?? \"\")\n    .replace(/```json/g, \"\")\n    .replace(/```/g, \"\")\n    .trim();\n\n  // JSON 파싱\n  let parsed;\n  try {\n    parsed = JSON.parse(cleaned);\n  } catch (e) {\n    parsed = { error: \"JSON parsing failed\", raw: cleaned };\n  }\n\n  // 개별 아이템으로 반환\n  return {\n    json: parsed\n  };\n});\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        16
      ],
      "id": "52329efc-f657-420d-a4e2-8a3b1442c4b0",
      "name": "JSON parsing5"
    },
    {
      "parameters": {
        "jsCode": "// 입력 필드 이름만 변경해서 사용하세요.\nconst ThumbNailImage = $('get images API').all()[0].json.data.thumbNailImageBase64;\n\n\n\n\nlet ThumbNailImageBase64 = null;\n\n// 문자열인지 체크\nif (typeof ThumbNailImage === \"string\" && ThumbNailImage.includes(\",\")) {\n  ThumbNailImageBase64 = ThumbNailImage.split(\",\")[1];\n}\n\n\nreturn [\n  {\n    json: {\n      ThumbNailImageBase64: ThumbNailImageBase64\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        16
      ],
      "id": "55083592-8dc8-4c0c-ad48-22fff1ea642a",
      "name": "make pure thumbnail image"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://{{ $('When Executed by Another Workflow').all()[0].json.IP }}/api/products/update-ai-images",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"productNumber\": \n    \"{{ $('When Executed by Another Workflow').all()[0].json.ProductID }}\",\n  \"AIThumbNailImage\": \n    \"{{ $('get images API').all()[0].json.data.thumbNailImageBase64 }}\",\n  \"AIMainImageUrls\": \n    [{{ $json.mainImagesresultBase64 }}],\n  \n  \"AISubImageUrls\": \n    [{{ $json.subImagesresultBase64 }}]\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        736,
        -208
      ],
      "id": "ec1184d7-3a4c-407d-831c-a08358f642e2",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "// 모든 input items 가져오기\nconst items = $('get images API').all();\n\nlet mainImagesList = [];\nlet subImagesList = [];\n\nfor (const item of items) {\n  const arr = item.json.data.mainImagesBase64;\n  if (Array.isArray(arr)) {\n    mainImagesList.push(...arr); \n  }\n}\n\nfor (const item of items) {\n  const arr = item.json.data.subImagesBase64;\n  if (Array.isArray(arr)) {\n    subImagesList.push(...arr); \n  }\n}\n\nconst mainImagesbase64List = mainImagesList\n  .map(str => {\n    if (!str) return null;\n\n    const parts = str.split(\",\");\n    return parts[1] ? parts[1] : parts[0]; \n  })\n  .filter(b => b); \n\nconst subImagesbase64List = subImagesList\n  .map(str => {\n    if (!str) return null;\n\n    const parts = str.split(\",\");\n    return parts[1] ? parts[1] : parts[0]; \n  })\n  .filter(b => b); \n\n\n\nconst mainImagesresult = mainImagesbase64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); \n\nconst subImagesresult = subImagesbase64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); \n\nreturn [\n  {\n    json: {\n      mainImagesresultBase64: mainImagesresult,\n      subImagesresultBase64: subImagesresult\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        592,
        -208
      ],
      "id": "c4b1a994-fb1f-4de5-a080-12627dfc9942",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4126ad34-525e-4e3b-9a38-6e24bf2a171c",
              "leftValue": "={{ $json.is_occluded}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        400,
        16
      ],
      "id": "8c4053a8-ae42-4809-9861-9be367e9d052",
      "name": "is thumbnail occluded?"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]  \n당신은 의류 리터칭 및 패션 디지털 합성 전문가입니다.  \n두 장의 이미지를 분석하여 다음 규칙에 따라 새로운 이미지를 생성하십시오.\n\n[입력 이미지 설명]  \n- 이미지 #1 : 최종 결과에서 **모델의 얼굴, 체형, 포즈, 카메라 각도, 조명**을 그대로 유지해야 하는 기준 이미지  \n- 이미지 #2 : 모델이 입고 있는 **의류의 색상 정보만 추출**해야 하는 참고 이미지  \n\n[핵심 지시사항]\n\n1. **이미지 #1의 요소는 그대로 유지**\n   - 모델의 얼굴 특징, 체형, 헤어스타일  \n   - 포즈, 손 위치, 다리 각도  \n   - 카메라 구도, 조명 분위기  \n   - 배경과 전체적인 장면 구성  \n\n2. **이미지 #2에서 가져오는 요소**\n   - 의류의 **정확한 색상(Color only)**  \n   - 색조, 채도, 명도 등 톤 정보   \n   - *디자인이나 형태는 절대 변경하지 않음.*\n\n3. **절대 변경하거나 가져오지 말아야 할 것**\n   - 이미지 #2의 모델 얼굴·포즈  \n   - 이미지 #2의 의상 형태(디자인, 실루엣, 패턴)  \n   - 이미지 #2의 배경 및 소품  \n   - 이미지 #1의 의상 디자인은 절대 변경 금지  \n     → 오직 \"색상\"만 대체 적용  \n\n4. **최종 생성 이미지 요구사항**\n   - 이미지 #1의 옷 **형태와 질감은 유지하되**,  \n     색상만 이미지 #2의 색과 일관되게 적용  \n   - 부자연스럽거나 덩어리진 색 번짐 없이 자연스러운 재질 표현  \n   - 전체 사진 품질은 원본 이상으로 선명하고 깨끗하게  \n\n[출력 형식]  \n\"이미지 #1의 모델과 포즈는 동일하게 유지하고, 의상의 색상만 이미지 #2의 색상으로 자연스럽게 대체한 고해상도 패션 합성 이미지 생성.\"\n\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6704,
        832
      ],
      "id": "cce1d2df-ba43-42ee-aed2-ec7abc6a4b59",
      "name": "make pure background-removed prompt1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0d11b096-9079-4d17-8f55-15741dbac017",
              "leftValue": "={{ $json.same_product }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        944,
        1440
      ],
      "id": "3b924c09-a61b-425c-9ddc-b16f7d9ce61c",
      "name": "Is Same Image?1"
    },
    {
      "parameters": {
        "jsCode": "const category = $('get images API1').all()[0].json.data.category;\nconst prompt = `\n당신은 패션 제품 비교 전문 비전 분석 모델입니다.\n두 장의 이미지를 입력받고, 입력된 **${category}**를 기반으로\n각 이미지 속에서 해당 카테고리에 해당하는 의류 제품만 정확히 찾아\n두 제품이 동일한 제품인지 여부를 판단하십시오.\n\n포즈, 모델의 체형, 조명, 착용 방식 차이는 모두 무시하고\n오직 의류의 실제 디자인 구조만 비교해야 합니다.\n\n🧠 [1. 카테고리 기반 제품 식별 규칙]\n\n입력받는 category를 기반으로 이미지 속에서 비교 대상이 되는 의류를 자동으로 식별하세요.\n\n예시:\n\ncategory: “상의-니트” → 니트 상의만 찾아 비교\n\ncategory: “아우터-코트” → 코트만 찾아 비교\n\ncategory: “하의-팬츠” → 팬츠만 찾아 비교\n\n⚠️ 이미지에 여러 의류 항목이 있더라도\n카테고리에 해당하는 제품 하나만 비교 대상으로 선택해야 합니다.\n카테고리에 해당하지 않는 요소(가방·스카프·이너·액세서리 등)는 무시합니다.\n\n🧪 [2. 비교 기준 — 반드시 세부적으로 판단]\n\n아래 항목 중 하나라도 의미 있는 차이가 있으면 동일 제품이 아닙니다.\n\n1) 어깨 구조\n\n어깨 길이(shoulder width)\n\n어깨선의 위치\n\n드롭숄더 여부\n\n어깨 라인의 각도 변화\n\n2) 암홀(Armhole)\n\n암홀 깊이\n\n암홀 곡선/직선 형태\n\n여유량 및 실루엣\n\n3) 소매 구조\n\n소매 길이\n\n소매 폭(슬림/루즈 여부)\n\n소매 형태(일자, 벌룬, 퍼프, 레글런 등)\n\n소매 단(커프스, 밴딩 등)의 형태\n\n4) 전체 실루엣 & 비율\n\n전체 실루엣(루즈/슬림/스트레이트)\n\n상·하단 비율\n\n몸통 폭, 품\n\n밑단 라인(일자/곡선/슬릿 유무)\n\n5) 디자인 요소\n\n버튼 개수·위치·간격\n\n포켓 형태·개수·배치\n\n카라 구조 (형태, 너비, 각도)\n\n봉제선(절개 라인)의 위치\n\n프린트·패턴 유무\n\n주름(핀턱·다트)의 유무\n\n6) 소재 & 텍스처\n\n니트 조직 패턴\n\n면/울/가죽/합성소재 등의 질감 차이\n\n패브릭 두께감\n\n7) 색상\n\n전체 색상 톤\n\n명도/채도\n\n특정 영역의 컬러 분포\n\n⚠ 주의:\n조명·촬영 환경으로 인한 밝기 차이는 허용하지만\n\"색상 톤 자체가 다른 경우\"는 동일 제품이 아님.\n\n📌 [3. 판단 시 무시해야 할 요소]\n\n아래는 비교에서 제외해야 하는 요소입니다.\n\n포즈 차이\n\n모델의 체형·자세\n\n조명·노출·명암 차이\n\n촬영 거리·카메라 각도\n\n옷의 일시적인 구김\n\n🧾 [4. 출력 형식 — JSON ONLY]\n\n반드시 아래 형식으로만 반환하십시오:\n\n{\n  \"same_product\": true or false,\n  \"reason\": \"두 이미지가 동일/상이한 이유를 디자인 요소 중심으로 간단하고 명확하게 기술\"\n}\n\n\n예시 reason:\n\n\"어깨 라인의 각도와 암홀 곡선이 명확히 다르므로 동일 제품이 아님\"\n\n\"소매 길이·포켓 위치·카라 구조가 완전히 일치하여 동일 제품으로 판단\"\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        96,
        1440
      ],
      "id": "77087945-86c5-40ed-a6d2-5406c41431bb",
      "name": "Make pure prompt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $('Make pure prompt').all()[0].json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('Make pure mainimages & background-removeds').all()[0].json.cutoutImageBase64 }}\"\n        }\n      },\n {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('Make pure mainimages & background-removeds').all()[0].json.mainImageBase64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\"]\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        496,
        1440
      ],
      "id": "08664886-4e13-4e8e-9fa9-9884cb002dc7",
      "name": "Check background-removed images",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mainImageUrls = $('get images API1').all()[0].json.data.mainImagesBase64 || [];\nconst cutoutImageUrls = $('get images API1').all()[0].json.data.backgroundRemovedImagesBase64 || [];\n\nreturn mainImageUrls.map((mainRaw, index) => {\n  const cutoutRaw = cutoutImageUrls[index] || null;\n\n  const mainPure = mainRaw.split(',')[1] || mainRaw;\n  const cutoutPure = cutoutRaw ? (cutoutRaw.split(',')[1] || cutoutRaw) : null;\n\n  return {\n    json: {\n      mainImageBase64: mainPure,\n      cutoutImageBase64: cutoutPure\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        1440
      ],
      "id": "4ffa4a6b-1ee9-486d-b531-7dec70de9a3e",
      "name": "Make pure mainimages & background-removeds"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst results = items.map(i => {\n  // 실제 JSON이 들어있는 경로\n  const raw = i.json?.candidates?.[0]?.content?.parts?.[0]?.text;\n\n  // ```json ``` 블록 제거\n  const cleaned = String(raw ?? \"\")\n    .replace(/```json/g, \"\")\n    .replace(/```/g, \"\")\n    .trim();\n\n  let parsed;\n  try {\n    parsed = JSON.parse(cleaned);\n  } catch (e) {\n    parsed = { error: \"JSON parsing failed\", cleaned };\n  }\n\n  return { json: parsed };\n});\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        1440
      ],
      "id": "b85df8c2-6190-404a-be87-6c6b40c06d5e",
      "name": "JSON parsing6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "34e598d1-a99a-4ce6-a9cd-4d3fedb304da",
              "leftValue": "={{ $('get images API1').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": "={{ $input.all().length }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1136,
        1296
      ],
      "id": "e0006363-2390-46ff-981c-dedd257de9a0",
      "name": "check true items count1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "34e598d1-a99a-4ce6-a9cd-4d3fedb304da",
              "leftValue": "={{ $('get images API1').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": "={{ $input.all().length }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1136,
        1456
      ],
      "id": "a8df2671-4ee9-430f-9dad-ab2c828f6151",
      "name": "check false items count1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://{{ $json.IP}}/api/products/images",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"productId\": \"{{ $json.ProductID }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -928,
        1440
      ],
      "id": "ae517980-eeba-4f8d-954d-25442136343f",
      "name": "get images API1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a083101d-0214-49ee-ad64-8bcfd66539a3",
              "leftValue": "={{ $json.isAccessory}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "9e41bd93-2a87-40cc-af11-ab22f54d278d",
              "leftValue": "={{ $json.isBag}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -592,
        1440
      ],
      "id": "76166a63-bd30-47ff-a834-e0220e0090e8",
      "name": "is accessory?1"
    },
    {
      "parameters": {
        "jsCode": "const text = $input.first().json.data.category;\n// \"악세사리-\" 로 시작하거나 포함되어 있는지 검사\nconst isAccessory = text.includes(\"악세사리\");\nconst isBag = text.includes(\"가방\");\n\nreturn [\n  {\n    json: {\n      original: text,\n      isAccessory,\n      isBag\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        1440
      ],
      "id": "1977dd1c-a288-4fb1-8ed5-72ed48986b05",
      "name": "check category1"
    },
    {
      "parameters": {
        "jsCode": "// 입력 필드 이름만 변경해서 사용하세요.\nconst ThumbNailImage = $('get images API1').all()[0].json.data.thumbNailImageBase64;\nconst SubImage = $('get images API1').all()[0].json.data.subImageSumImage;   // ← 여기에 필드명 지정\n\n\n\nlet ThumbNailImageBase64 = null;\nlet SubImageBase64 = null;\n// 문자열인지 체크\nif (typeof ThumbNailImage === \"string\" && ThumbNailImage.includes(\",\")) {\n  ThumbNailImageBase64 = ThumbNailImage.split(\",\")[1];\n}\n\nif (typeof SubImage === \"string\" && SubImage.includes(\",\")) {\n  SubImageBase64 = SubImage.split(\",\")[1];\n}\n\nreturn [\n  {\n    json: {\n      ThumbNailImageBase64: ThumbNailImageBase64,\n      SubImageBase64: SubImageBase64\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5456,
        1904
      ],
      "id": "556a8ed6-b51e-4c02-a39d-f3fda90ff22e",
      "name": "make pure base"
    },
    {
      "parameters": {
        "jsCode": "const category = $('get images API1').all()[0].json.data.category;\n\nconst prompt = `[시스템 역할]\n당신은 엄격한 규정을 따르는 전문 패션 이커머스 에디터이며,\n카테고리와 첨부된 제품 이미지들을 기반으로 모델 착용 이미지를 생성해야 합니다.\n\n당신의 임무는 다음과 같습니다:\n**카테고리 : ${category}**를 기준으로\n첨부된 이미지 안에서 해당 카테고리에 해당하는 제품을 정확히 찾아내고\n그 제품을 모델이 착용한 새로운 착용컷 이미지를 생성하는 것입니다.\n\nI. [모델 페르소나 카드] – 일관성 유지 (Critical Model Consistency)\n모든 이미지에서 아래 모델 페르소나를 완전히 유지해야 합니다.\n성별/연령: 20대 후반–30대 초반의 세련된 한국 여성/남성\n얼굴 특징:\n\n얼굴 전체가 명확히 보임\n시크하고 무심한 표정\n입체적인 이목구비\n정면 또는 살짝 비켜가는 시선\n\n헤어:\n\n자연스러운 질감의 짧은 단발 또는 정돈된 미디엄\n짙은 갈색 컬러\n\n피부톤:\n\n매트하고 건강한 쿨톤\n자연스러운 메이크업\n\n분위기:\n\n도시적, 전문적, 하이엔드 매거진 화보 느낌\n\nII. 제품 식별 규칙 (카테고리 기반 Product Identification Rule)\n1) 첨부 이미지 속에서 해당 카테고리와 매칭되는 제품을 탐지\n\n카테고리 구조는 다음과 같이 구성됨:\n대분류-중분류-소분류\n예) 의류–스커트–롱, 악세사리–모자–비니 등\n\n이미지 속 실제 제품의 형태·재질·실루엣을 기반으로 가장 정확하게 매칭되는 제품을 선택.\n\n2) 선택된 제품의 모든 디테일을 그대로 유지\n\n✔ 색상 (Hue/Saturation/Brightness)\n✔ 실루엣\n✔ 주름\n✔ 패턴\n✔ 버튼·포켓 위치\n✔ 질감\n✔ 핏\n\n⚠ 원본과 단 1px도 다르게 생성되면 안 됨.\n\n3) 해당 제품을 모델이 자연스럽게 착용한 상태로 재구성\n\n제품 변형 금지\n\n왜곡 금지\n\n색 보정 금지\n\nIII. 이미지 생성 규칙 (상품 유지가 최우선)\n원본 상품이 절대적으로 동일해야 한다.\n\n색상 변경 금지\n➤ 원본 상품의 색상(Hue, Saturation, Brightness 포함 모든 Color Attribute)은 1px도 변화하면 안 된다.\n➤ AI가 자동 보정/화이트밸런스/조명 영향 등을 핑계로 색조가 바뀌는 것도 금지.\n➤ 원본 제품 색상은 RAW Color처럼 그대로 잠금 상태(Color-locked)로 유지해야 한다.\n디테일 변경 금지\n소재/핏/버튼/포켓 위치/패턴/천 질감 모두 동일하게 유지\n모델이 실제로 그 상품을 입은 것처럼 자연스럽게 재현할 것\n\n옷이 돋보이도록 코디는 더욱 세련되게 구성하되, 상품을 방해하지 않을 것.\n모델 얼굴은 꼭 보여야 한다.\n모델 포즈:\n\n모델은 정면을 보고 서 있으며, 한쪽 손은 바지 주머니에 넣고 다른 쪽 어깨에는 가방을 메고 있습니다.\n몸은 정면을 향하지만 시선은 약간 오른쪽\n전체적으로 편안하고 안정적인 스탠딩 포즈\n\n상세 이미지 비율: 1 : 1.2\n코디 규칙:\n\n코디되는 다른 의류는 체크 패턴 절대 금지\n하의는 다음 중 하나만 허용: 부츠컷 팬츠 / 슬랙스 와이드 핏\n신발은 다음 중 하나만 허용: 플랫 로퍼 / 운동화 (굽 높은 구두 절대 금지)\nwinter season → 짙은 색상\n가방은 명품 느낌 금지, 심플하고 미니멀한 디자인만 사용\n\n상품 디테일 재현 매우 중요:\n\n옷의 질감, 주름, 버튼, 실루엣, 컬러, 핏 모두 원본과 동일\n사진 속 조명/환경 변화에도 상품이 원본과 정확히 같아야 함\n\n\n⚡ 추가 규칙 — \"모델 다리 길이 증가 (Leg-Elongation Rule)\"\n아래 규칙을 새로 추가합니다. 필수 적용입니다.\n\n모델의 다리는 일반적인 비율보다 길고 슬림하게, 패션 화보 스타일의 롱 레그 비율을 적용하여 연출하십시오.\n단, 신체 비율이 부자연스럽지 않도록 프로 패션 촬영처럼 자연스럽게 연장하십시오.\n다리를 길게 만들 때에도 상품(외투/아우터/상의)의 핏이 왜곡되거나 변형되면 절대 안 된다.\n하의 실루엣(부츠컷/와이드핏)도 그대로 유지한 상태에서 전체적인 비율만 슬림하고 길어 보이도록 처리.\n발 위치·바닥·그림자도 현실적인 비례감으로 조정해 자연스러움을 유지할 것.\n\n\n🚫 III. 텍스트 생성 절대 금지 (NO TEXT GENERATION - CRITICAL)\n⚠️ 이 규칙은 최우선 적용됩니다.\n❌ 절대 금지 사항:\n\n이미지 내에 새로운 텍스트, 글자, 문자, 숫자, 기호를 생성하지 마십시오\n브랜드명, 로고, 워터마크, 라벨을 새로 만들지 마십시오\n옷에 글씨나 프린트를 추가하지 마십시오 (원본에 없는 경우)\n배경에 간판, 문구, 장식 텍스트를 넣지 마십시오\n어떤 형태의 텍스트도 AI가 임의로 생성해서는 안 됩니다\n\n\"DO NOT generate, add, or create ANY text, letters, numbers, logos, watermarks, or written elements that do not exist in the original image. Text generation is strictly prohibited.\"\n\nIV. 주의사항 (Critical)\n\n원본 상품 디테일이 1px도 바뀌면 안 된다\n이미지를 생성하더라도 텍스트, 설명, 정보 배치는 100% 동일하게 유지\n모델컷만 교체\n상품 실루엣/색상/질감 충실하게 복원\n다리 길이 증가 포함\n새로운 텍스트 생성 절대 금지\n전체 결과물은 \"진짜 모델이 그 상품을 착용한 것처럼\" 보여야 한다`;\n\n \n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5616,
        1904
      ],
      "id": "eca91b4f-e1e3-406b-a1cd-f97ac46ee8f0",
      "name": "make pure thumbnailPrompt1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $json.cleanedPrompt }} },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('make pure base').all()[0].json.ThumbNailImageBase64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        5792,
        1904
      ],
      "id": "ae5a5b56-a2fe-4edc-8746-43a3991680f0",
      "name": "create thumbnail1",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\n# ==========================================================\n# 1) base64 입력 받기\n# ==========================================================\nbase64_input = _input.first().json.candidates[0].content.parts[0].inlineData.data\n\nif not base64_input:\n    raise Exception(\"base64 이미지 데이터를 찾을 수 없습니다.\")\n\nimage_data = base64.b64decode(base64_input)\n\n# ==========================================================\n# 2) 이미지 로드\n# ==========================================================\nimg = Image.open(BytesIO(image_data))\n\n# ==========================================================\n# 3) 비율 유지 + width 700px 리사이즈\n# ==========================================================\ntarget_width = 700\nw, h = img.size\nratio = target_width / float(w)\ntarget_height = int(h * ratio)\n\nresized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n# ==========================================================\n# 4) 다시 base64로 변환\n# ==========================================================\nbuffered = BytesIO()\nresized_img.save(buffered, format=\"JPEG\")\noutput_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n# ==========================================================\n# 5) n8n Output (반드시 list 반환)\n# ==========================================================\nreturn [\n    {\n        \"width\": target_width,\n        \"height\": target_height,\n        \"ThumbnailImage_Base64\": output_base64\n    }\n]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5952,
        1904
      ],
      "id": "65d7a491-5df7-43af-83ed-fb347596db78",
      "name": "resize thumbnail1"
    },
    {
      "parameters": {
        "content": "## Create all image",
        "height": 80,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -928,
        1328
      ],
      "id": "5695e2d0-5290-4484-88b7-6a018b0da21b",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "### Create thumbnail image",
        "height": 80,
        "width": 224,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        5792,
        1792
      ],
      "id": "02245fcd-3555-402c-8217-c9ceee2d04e9",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=당신은 패션 제품 분석에 특화된 전문 비전 감지 AI입니다.  \n당신의 역할은 **첨부된 제품 사진이 새로운 이미지 생성에 적합한지**,  \n즉 **제품이 사람의 신체나 다른 사물에 의해 가려져 있지 않은지**를  \n정확하게 판단하는 것입니다.\n\n당신은 절대 이미지를 생성하거나 수정하지 않습니다.  \n오직 “판단/평가”만 수행합니다.\n\n────────────────────────────\n[입력 정보]\n- 제품 카테고리: {{ $('get images API1').all()[0].json.data.category }}\n\n────────────────────────────\n[AI의 주요 임무]\n\n사진 속 제품이 아래 기준에 따라 가려져 있는지를 판단하시오:\n\n1) **제품 전체가 온전히 보이는가?**\n   - 카테고리 기준 주요 구성 요소가 프레임 안에 모두 포함되어야 함.\n   - 일부라도 신체·소품·카메라 각도 때문에 보이지 않으면 “가려짐(true)”로 판단.\n\n2) **신체(머리·팔·손·다리 등)에 의해 제품 일부가 가려져 있는가?**\n   - 모델 착용 사진인 경우, 팔·손·머리카락 등이 제품 라인을 심하게 가리면 가려진 것으로 판단.\n\n3) **배경의 사물, 소품, 텍스트, 그림자 등으로 제품이 가려져 있는가?**\n\n4) **카메라각도 때문에 중요한 디테일이 보이지 않는가?**\n   - 예: 옆모습만 보이고 앞면 실루엣 확인 불가 → 가려짐(true)\n\n─────\n[카테고리별 중요 노출 요소 — 반드시 기준에 포함하여 판단]\n- 상의(자켓, 티셔츠, 니트 등): 어깨선, 암홀, 전체 몸판, 소매, 밑단\n- 하의(바지/스커트): 허리 라인, 밑단, 전체 실루엣\n- 원피스: 상·하 신체 전체 실루엣, 어깨~밑단\n- 아우터: 카라/라펠, 어깨, 소매 전체, 몸판 전체\n- 가방: 바디 전체, 스트랩 형태\n- 신발: 발등, 앞코, 측면, 뒤축\n- 액세서리(모자/벨트/목걸이 등): 전체 실루엣이 명확히 보여야 함\n\n────────────────────────────\n[출력 형식(JSON만 반환)]\n\n아래 형식을 반드시 그대로 출력하시오:\n{\n  \"is_occluded\": true | false,\n  \"reason\": \"왜 이렇게 판단했는지 상세 설명\"\n}\n\n- true  → 제품이 가려져 있음 (새로운 이미지 생성에 부적합)\n- false → 제품이 온전히 보이며 생성에 사용 가능",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        4768,
        1888
      ],
      "id": "f9b2c73e-d0a4-40b8-85e8-3fdc0777029d",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4768,
        2064
      ],
      "id": "ce219d83-b804-4f45-ad58-973308501b89",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "e7t27ilShPQLOWu7",
          "name": "Google Geminie Soonicron API"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('get images API1').all()[0].json.data.category }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4864,
        2064
      ],
      "id": "f89f6756-8d3f-45b5-bd48-dcec6420de63",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "ThumbNailImageBase64",
        "binaryPropertyName": "Image",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        4608,
        1888
      ],
      "id": "56a88f12-c4d9-45b6-b66a-2b88f5c1b5bb",
      "name": "convert imageFIle2"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// 각 아이템을 개별적으로 처리하여 결과 아이템 배열 생성\nconst results = items.map(i => {\n  const raw = i.json.output;\n\n  // ```json ``` 블록 제거\n  const cleaned = String(raw ?? \"\")\n    .replace(/```json/g, \"\")\n    .replace(/```/g, \"\")\n    .trim();\n\n  // JSON 파싱\n  let parsed;\n  try {\n    parsed = JSON.parse(cleaned);\n  } catch (e) {\n    parsed = { error: \"JSON parsing failed\", raw: cleaned };\n  }\n\n  // 개별 아이템으로 반환\n  return {\n    json: parsed\n  };\n});\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5056,
        1888
      ],
      "id": "14f8600b-aaca-4d7f-90fa-43ef41a81c5c",
      "name": "JSON parsing7"
    },
    {
      "parameters": {
        "jsCode": "// 입력 필드 이름만 변경해서 사용하세요.\nconst ThumbNailImage = $('get images API1').all()[0].json.data.thumbNailImageBase64;\n\n\n\n\nlet ThumbNailImageBase64 = null;\n\n// 문자열인지 체크\nif (typeof ThumbNailImage === \"string\" && ThumbNailImage.includes(\",\")) {\n  ThumbNailImageBase64 = ThumbNailImage.split(\",\")[1];\n}\n\n\nreturn [\n  {\n    json: {\n      ThumbNailImageBase64: ThumbNailImageBase64\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4416,
        1888
      ],
      "id": "9ffc62d1-8a0c-49d9-846b-714ad6770ecb",
      "name": "make pure thumbnail image1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4126ad34-525e-4e3b-9a38-6e24bf2a171c",
              "leftValue": "={{ $json.is_occluded}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5216,
        1888
      ],
      "id": "a34a2cbf-8c29-4948-8f4f-ddbb1aa09584",
      "name": "is thumbnail occluded?1"
    },
    {
      "parameters": {
        "jsCode": "const cutoutImageUrls = $('get images API1').all()[0].json.data.backgroundRemovedImagesBase64 || [];\n\nreturn [\n  {\n    json: {\n      count: cutoutImageUrls.length\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -368,
        1456
      ],
      "id": "15987873-1e3e-40c5-8f78-3a33b070b0d1",
      "name": "get background-removed count"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4aa3329c-c84f-43d4-b191-24892b351960",
              "leftValue": "={{ $json.count}}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -176,
        1456
      ],
      "id": "a5fdd6c1-1ae6-4d15-b470-93301b2232ec",
      "name": "check background-removed count greater than 0?"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=당신은 전문 의류 전처리 품질검사 AI 에이전트입니다.\n입력된 제품 이미지가 CUTOUT(의류만 분리) 작업을 수행하기에 적합한지를 판단하는 역할을 합니다.\n어떤 이미지든 직접 생성하거나 수정하지 않으며, 오직 “분석/판단”만 수행합니다.\n\n🎯 [AI의 핵심 임무]\n\n입력된 이미지를 보고 아래 항목을 정확하게 평가하시오:\n\n1) 의류가 정면을 향하고 있는가?\n\n2) 의류 전체가 프레임 안에 온전히 포함되어 있는가?\n   - 일부가 잘려 있다면 실패로 판단\n\n3) 심한 그림자, 어두운 영역, 배경 복잡도 등 CUTOUT 정확도를 방해하는 요소는 없는가?\n\n4) 색상 왜곡 가능성이 있는 조명(강한 역광/컬러조명)이 존재하는가?\n\n5) 전체적으로 CUTOUT이 “정확하게 생성될 가능성”을 High / Medium / Low 로 평가하시오.\n\n   📌 *white_background = true 조건 (아주 엄격함)*  \n   다음 조건을 모두 충족해야 `\"is_white_background\": true` 로 판정한다:\n\n   - 배경이 단색 흰색 또는 회색같은 단색이어야 한다.  \n   - 배경에 **사람, 신체 일부(머리, 얼굴, 팔, 손, 다리), 머리카락, 그림자 실루엣, 가구, 소품, 악세서리, 장식물 등 단 하나라도 존재하면 false**  \n   - 배경에 **패턴, 텍스처, 그라데이션, 색 번짐, 노이즈, 그림자 얼룩** 등이 보이면 false  \n   - **제품 외 객체가 프레임 안에 존재하면 무조건 false**  \n   - 의류 자체의 자연 그림자(밑단 아래 약한 회색 그림자)는 허용  \n   - 단순 흰 배경 + 오직 제품 하나만 있는 구성일 때만 true  \n   - 즉, \"스튜디오 누끼샷\"처럼 **사람 없이 순수 제품만 촬영된 이미지**여야 한다.\n\n   위 조건 중 하나라도 불충족하면 `\"is_white_background\": false` 로 판정한다.\n\n────────────────────────────\n📌 [정면 기준 판단 규칙]\n\n다음 조건을 충족하면 “정면”으로 간주:\n- 의류 중심선(지퍼, 버튼 라인)이 수직에 가깝다\n- 좌우 소매 길이가 크게 다르지 않다\n- 어깨 라인이 비대칭으로 기울지 않았다\n- 몸통이 비틀리거나 과하게 회전하지 않았다\n- 제품 각도(치우침, 옆모습)가 심하지 않다\n\n────────────────────────────\n📌 [CUTOUT 가능성 판단 기준]\n\n다음 요소가 하나라도 심각하면 CUTOUT 가능성 Low:\n- 인체 실루엣이 의류 형태를 가림\n- 배경과 의류 색상이 비슷해 경계가 흐림\n- 높은 잡음, 저해상도, 흔들림, 블러\n- 의류 일부가 프레임 밖으로 나감\n- 머리카락/손/팔 등 신체가 의류를 가림\n- 강한 그림자/반사로 경계 인식이 어려움\n\n────────────────────────────\n📌 [AI 출력 형식 — 반드시 아래 형식으로만 반환]\n\n{\n  \"is_front_facing\": true/false,\n  \"clothing_fully_visible\": true/false,\n  \"is_white_background\": true/false,\n  \"cutout_quality\": \"High\" | \"Medium\" | \"Low\",\n  \"reason\": \"판단 근거를 간단히 기술\"\n}\n",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1920,
        1440
      ],
      "id": "1eb6811e-09b1-49c6-84c5-7fc0d9a67c8c",
      "name": "AI Agent5"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1920,
        1648
      ],
      "id": "57ea4b50-b3ce-46b3-b2a8-d8ac03b2e2ab",
      "name": "Google Gemini Chat Model5",
      "credentials": {
        "googlePalmApi": {
          "id": "e7t27ilShPQLOWu7",
          "name": "Google Geminie Soonicron API"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "1"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        2016,
        1648
      ],
      "id": "d920af54-d322-4d34-884c-432ddfb2de4e",
      "name": "Simple Memory5"
    },
    {
      "parameters": {
        "jsCode": "const mainImageUrls = $('get images API1').all()[0].json.data.mainImagesBase64 || [];\n\nreturn mainImageUrls.map((mainRaw) => {\n\n  // \"data:image/...,\" 제거\n  const mainPure = mainRaw.split(',')[1] || mainRaw;\n\n  return {\n    json: {\n      mainImageBase64: mainPure\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1520,
        1440
      ],
      "id": "8308413f-b322-4d4a-945c-7ac7f215727b",
      "name": "make pure mainImages base"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "mainImageBase64",
        "binaryPropertyName": "Image",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        1728,
        1440
      ],
      "id": "6e3f65c3-8f12-4235-99f0-4bc3af1e5215",
      "name": "convert imageFIle3"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// 각 아이템을 개별적으로 처리하여 결과 아이템 배열 생성\nconst results = items.map(i => {\n  const raw = i.json.output;\n\n  // ```json ``` 블록 제거\n  const cleaned = String(raw ?? \"\")\n    .replace(/```json/g, \"\")\n    .replace(/```/g, \"\")\n    .trim();\n\n  // JSON 파싱\n  let parsed;\n  try {\n    parsed = JSON.parse(cleaned);\n  } catch (e) {\n    parsed = { error: \"JSON parsing failed\", raw: cleaned };\n  }\n\n  // 개별 아이템으로 반환\n  return {\n    json: parsed\n  };\n});\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        1440
      ],
      "id": "eb9a78b4-edc4-40c2-90a6-399ffa9e15ae",
      "name": "JSON parsing8"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4126ad34-525e-4e3b-9a38-6e24bf2a171c",
              "leftValue": "={{ $json.is_white_background}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2432,
        1440
      ],
      "id": "85ce272a-5cde-4879-8302-c8136a5379b6",
      "name": "is background-removed image?1"
    },
    {
      "parameters": {
        "jsCode": "// 모든 input items 가져오기\nconst items = $('get images API').all();\n\n\n// backgroundRemovedImagesBase64 배열 모두 모으기\n// 예: item.json.backgroundRemovedImagesBase64 = [\"data:image...\",\"data:image...\"]\nlet rawList = [];\n\nfor (const item of items) {\n  const arr = item.json.data.mainImagesBase64;\n  if (Array.isArray(arr)) {\n    rawList.push(...arr); // 배열 펼쳐서 추가\n  }\n}\n\n// base64만 추출하고, undefined/null/빈 문자열 제외\nconst base64List = rawList\n  .map(str => {\n    if (!str) return null;\n\n    // \"data:image/jpeg;base64,XXXX\" → \"XXXX\"만 추출\n    const parts = str.split(\",\");\n    return parts[1] ? parts[1] : parts[0]; \n  })\n  .filter(b => b); // falsy 제거\n\n// 결과를 \"값\", \"값\", \"값\" 형태로 출력 (마지막 콤마 없음)\nconst result = base64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); \n\nreturn [\n  {\n    json: {\n      backgroundRemovedImagesBase64: result\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2896,
        1152
      ],
      "id": "8e329b5c-53a2-47b9-a871-9b880e51a5ec",
      "name": "make postData2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "41b3c35d-f2ab-49ce-a84a-d21d40e954bd",
              "leftValue": "={{ $('get images API1').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": "={{ $input.all().length }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            },
            {
              "id": "66164562-f318-4543-ab8b-004a38bfd205",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2640,
        1344
      ],
      "id": "c982d1e1-5dfb-43d6-b96d-8349c577bcb9",
      "name": "check true items count2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5f17c3e0-f3bc-47fa-98fa-a978f8c74fb7",
              "leftValue": "={{ $('get images API1').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": "={{ $input.all().length }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2640,
        1536
      ],
      "id": "2db5b4b9-e770-4c86-9dd3-6eaa7b895da8",
      "name": "check false items count2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://{{ $('When Executed by Another Workflow').all()[0].json.IP }}/api/products/update-background-removed",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"productNumber\": \"{{ $('When Executed by Another Workflow').all()[0].json.ProductID }}\",\n  \"backgroundRemovedImages\": [{{ $json.backgroundRemovedImagesBase64 }}]\n}\n\n\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3072,
        1152
      ],
      "id": "fe0928d2-73bf-4501-834c-2361cdd34135",
      "name": "post background-removed image2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "85adc80f-b990-4528-b94f-d338194f943d",
              "leftValue": "={{ $json.is_front_facing }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "36f22d9d-2efb-44b8-9cba-5436c218b9d8",
              "leftValue": "={{ $json.clothing_fully_visible}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2960,
        1360
      ],
      "id": "539270f5-2461-4446-ae23-685917d50961",
      "name": "can create background-removed images?1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f35afcd9-47c3-41ce-9a3d-bdb33bd513ee",
              "leftValue": "={{ $('get images API1').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": "={{ $input.all().length }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3248,
        1344
      ],
      "id": "02a7a0a1-d1e5-4daa-8f1f-1fbb03588441",
      "name": "check true items count "
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f35afcd9-47c3-41ce-9a3d-bdb33bd513ee",
              "leftValue": "={{ $('get images API1').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": "={{ $input.all().length }}",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3248,
        1584
      ],
      "id": "a1452611-99fe-4f90-ac99-ca981d016ed2",
      "name": "check false items count "
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6cf78535-14a3-4ea7-be07-3ee533242fe2",
              "leftValue": "={{ $('get images API1').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3696,
        1328
      ],
      "id": "c50cfe57-a602-4083-a6d4-9d7a658f92c9",
      "name": "check mainImages count2"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]\n당신은 패션 제품 색상 비교에 특화된 전문 비전 모델입니다.\n입력된 두 장의 이미지를 분석하여 두 이미지 속 제품의 ‘색상(Color)’이 동일한지 여부만을 판단해야 합니다.\n\n📌 판단 기준 (Color-Only Judgment Rules)\n\n두 이미지의 제품이 다음 조건을 만족하면 \"same_color = true\",\n하나라도 다르면 \"same_color = false\" 로 판단합니다.\n\n✔ 동일하다고 판단되는 경우\n\n색상(Hue), 명도(Brightness), 채도(Saturation)가 촬영 환경 차이로 인한 미세한 변화 수준\n\n자연스러운 조명 변화(실내/실외, 밝기 차이 등)로 인한 오차\n\n그림자, 반사광으로 인한 부분적 색 변화\n\n❌ 다르다고 판단되는 경우\n\n주요 색상 자체가 다름 (예: 베이지 vs 브라운, 검정 vs 차콜 등)\n\n전체적으로 Hue 또는 Saturation이 다른 색 계열\n\n원단이 동일해 보이지 않을 정도의 강한 색조 차이\n\nAI가 자동 보정한 듯한 색 틀어짐\n\n🚫 비교 대상에서 제외되는 요소\n\n색상 판단만 수행하며 다음 요소는 판단에 포함하지 않습니다:\n\n실루엣, 핏, 길이, 버튼, 포켓, 패턴 등 디자인 변화\n\n이미지 해상도\n\n모델 또는 배경 차이\n\n전체 사진의 톤 스타일\n\n📤 출력 형식 (반드시 아래 형식으로만 출력)\n\n아래 JSON 하나만 출력합니다:\n\n{\n  \"same_color\": true | false,\n  \"reason\": \"짧고 명확한 색상 판단 근거\"\n}\n\n\n출력 외 다른 텍스트는 절대 생성하지 마십시오.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        1344
      ],
      "id": "fd7997df-6319-4701-bc3e-71ec8a921c29",
      "name": "make pure color-judgment prompt2"
    },
    {
      "parameters": {
        "jsCode": "const urls = $('get images API1').all()[0].json.data.mainImagesBase64 || [];\nconst len = urls.length;\n\n// 사용할 인덱스 결정\nlet idx1, idx2;\n\nif (len === 2) {\n  idx1 = 0;\n  idx2 = 1;\n} else if (len >= 3) {\n  idx1 = 1;\n  idx2 = 2;\n} else {\n  // 이미지가 2개 미만이면 null 처리\n  return [\n    {\n      json: {\n        img1_base64: null,\n        img2_base64: null,\n        message: \"이미지가 2개 미만입니다.\"\n      }\n    }\n  ];\n}\n\n// Base64 순수값 추출 함수\nconst extract = (raw) => raw ? (raw.split(',')[1] || raw) : null;\n\nreturn [\n  {\n    json: {\n      img1_base64: extract(urls[idx1]),\n      img2_base64: extract(urls[idx2])\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4160,
        1344
      ],
      "id": "db5ace81-72a0-4563-b24b-cde09917d4d9",
      "name": "make pure mainImages base64 data2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $('make pure color-judgment prompt2').all()[0].json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.img1_base64 }}\"\n        }\n      },\n {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.img2_base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\"]\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4368,
        1344
      ],
      "id": "637b69f5-05db-4a38-9bdf-20234bf84343",
      "name": "color-judgment2",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const res = $input.first().json;\n\n// text 추출\nlet raw = res.candidates?.[0]?.content?.parts?.[0]?.text ?? \"\";\n\n// 코드블록 제거\nraw = raw.replace(/```json|```/g, \"\").trim();\n\n// JSON 파싱\nlet parsed = null;\ntry {\n  parsed = JSON.parse(raw);\n} catch (e) {\n  parsed = { error: \"JSON 파싱 실패\", raw };\n}\n\nreturn [\n  {\n    json: parsed\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4576,
        1344
      ],
      "id": "8802fe38-9165-42bc-bf8a-e7e297edf3fe",
      "name": "JSON parsing9"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6c5436a8-f43a-4c6c-95db-6ea953569747",
              "leftValue": "={{ $json.same_color }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4800,
        1344
      ],
      "id": "e19fe193-7970-4cc8-95be-534228db4535",
      "name": "is same color?2"
    },
    {
      "parameters": {
        "jsCode": "const urls = $('get images API1').all()[0].json.data.mainImagesBase64;\n\nreturn urls.map((u, index) => {\n  const pureBase64 = u.split(',')[1] || u; // \"data:image/...,\" 제거\n  return {\n    json: {\n      base64: pureBase64\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5264,
        1360
      ],
      "id": "32a4c23d-e768-4194-9635-192e7a6e7d7d",
      "name": "make pure mainImage base64 data2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://{{ $('When Executed by Another Workflow').all()[0].json.IP }}/api/products/update-background-removed",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"productNumber\": \"{{ $('When Executed by Another Workflow').all()[0].json.ProductID }}\",\n  \"backgroundRemovedImages\": [\n{{ $json.CutoutImage_Base64 }}\n  ]\n}\n\n\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7376,
        1360
      ],
      "id": "75a9bba5-8189-4c4b-aa88-c042052bbbf6",
      "name": "post background-removed image3"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\noutputs = []\n\n# ==========================================================\n# 1) input 전체 반복 처리\n# ==========================================================\nfor item in _input.all():\n\n    # base64 위치 추출 (없으면 skip)\n    base64_input = item.json.get(\"candidates\", [])[0].get(\"content\", {}).get(\"parts\", [])[0].get(\"inlineData\", {}).get(\"data\")\n\n    if not base64_input:\n        outputs.append({\n            \"error\": \"base64 이미지 데이터를 찾을 수 없습니다.\",\n            \"original_item\": item.json\n        })\n        continue\n\n    # base64 decode\n    image_data = base64.b64decode(base64_input)\n\n    # ==========================================================\n    # 2) 이미지 로드\n    # ==========================================================\n    img = Image.open(BytesIO(image_data))\n\n    # ==========================================================\n    # 3) 비율 유지 + width 700px 리사이즈\n    # ==========================================================\n    target_width = 700\n    w, h = img.size\n    ratio = target_width / float(w)\n    target_height = int(h * ratio)\n\n    resized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n    # ==========================================================\n    # 4) 다시 base64로 변환\n    # ==========================================================\n    buffered = BytesIO()\n    resized_img.save(buffered, format=\"JPEG\")\n    output_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n    # ==========================================================\n    # 5) output 배열에 추가\n    # ==========================================================\n    outputs.append({\n        \"width\": target_width,\n        \"height\": target_height,\n        \"CutoutImage_Base64\": output_base64\n    })\n\n# ==========================================================\n# 6) n8n Output (items list 반환)\n# ==========================================================\nreturn outputs\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5648,
        1360
      ],
      "id": "b4619e3c-ca11-4c3b-9a48-0ccc44981321",
      "name": "resize background-removed image2"
    },
    {
      "parameters": {
        "jsCode": "// 모든 input items\nconst items = $input.all();\n\n// base64만 추출하고, undefined/null/빈 문자열 제외\nconst base64List = items\n  .map(i => i.json.CutoutImage_Base64)\n  .filter(b => b); // falsy 값 제거(undefined, null, \"\", 0)\n\n// ✨ 마지막 콤마 제거 버전 ✨\n// 각 값 앞뒤에 큰따옴표만 추가하고 join(\", \")으로 연결\nconst result = base64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); // 자동으로 마지막 콤마 제거됨\n\nreturn [\n  {\n    json: {\n      CutoutImage_Base64: result\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5840,
        1360
      ],
      "id": "c8b55772-92a8-4c36-b658-4b138012caae",
      "name": "sum background-removed image2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $('make pure background-removed prompt2').all()[0].json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        5456,
        1360
      ],
      "id": "3ed72daf-1764-4b2c-854c-a4cbdc9d77d9",
      "name": "create background-removed image2",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const category = $('get images API').all()[0].json.data.category;\n\n\nconst prompt = `\n🧠 [시스템 역할] — Garment Extraction AI\n\n당신의 작업은 입력 이미지에서 ** ${category} **로 지정된 의류만 정확하게 인식·분리한 뒤,\n사람·배경·소품을 100% 제거하고,\n순수 흰색(#FFFFFF) 배경 위에 해당 의류만 단독으로 재구성하는 것입니다.\n\n입력으로 제공되는 요소:\n\n이미지\n\n카테고리 (예: 상의-니트, 하의-팬츠, 아우터-코트 등)\n\n당신은 먼저 이미지 속에서 카테고리에 해당하는 의류를 정확히 찾아야 하며,\n해당 의류만을 대상으로 아래의 모든 규칙을 적용하여 결과 이미지를 생성해야 합니다.\n\n📌 1. 절대 변경 금지 규칙 (CRITICAL – 반드시 지킬 것)\n🎨 [색상 정확도 – ABSOLUTE COLOR PRESERVATION]\n\n색상은 단 1%라도 변경되면 안 됨.\n\n원본 의류의 색상, 명도, 채도, 톤, 텍스처 그대로 유지\n\n화이트밸런스 조정 금지\n\n대비/채도/톤/커브 조정 금지\n\n선명도·질감 보정 금지\n\n“더 예쁘게/더 선명하게” 같은 개선 작업 금지\n\n네이비는 네이비 그대로, 미세한 톤 변화도 허용되지 않음\n\n📌 2. 길이·비율 유지 규칙 (LENGTH & PROPORTION)\n\n의류의 실루엣, 길이, 폭, 형태는 절대로 수정 금지.\n\n총장, 어깨너비, 소매길이 등 원본 그대로\n\n늘리기, 줄이기, 비율 조정 금지\n\n형태 보정·라인 보정 금지\n\n더 깔끔하거나 균형 잡힌 모습으로 재구성하려는 시도 금지\n\n📌 3. 원본 충실도 규칙 (FAITHFUL REPRODUCTION)\n\n원본에 있는 디테일은 모두 보존\n\n존재하지 않는 디테일, 주름, 스티치 등을 생성 금지\n\n인체 착용으로 인해 생긴 부자연스러운 주름은 제거 가능\n\n의류 고유의 자연스러운 주름·질감은 유지\n\n📌 4. 제거해야 할 요소 (REMOVAL REQUIREMENTS)\n\n다음 요소는 100% 제거:\n\n👤 사람 관련 요소\n\n얼굴, 팔, 다리, 손, 머리카락, 피부\n\n인체 실루엣 흔적, 볼륨감\n\n착용으로 남는 몸매 윤곽\n\n🎒 액세서리·소품\n\n가방, 장신구, 머플러, 모자, 시계 등\n(단, 의류 자체 구성 요소는 제거 금지)\n\n🏠 배경\n\n실내/실외 배경\n\n바닥, 벽, 반사, 그림자\n\n바닥 그림자도 가능한 최소화 또는 제거\n\n📌 5. 출력 스타일 (GARMENT PRESENTATION)\n🔄 정렬 & 대칭\n\n좌우 완벽한 대칭\n\n카메라 정면 기준 정확한 수평·수직\n\n중심 지퍼/버튼 → 완전한 수직\n\n어깨 라인 → 정확히 수평\n\n소매 길이·폭 균일하게 정렬\n\n👕 형태\n\n플랫레이(flat-lay) 또는 고스트 마네킹 스타일\n\n자연스러운 형태 유지\n\n압축·납작함 금지\n\n모든 주름, 질감, 스티치, 디테일 최대 보존\n\n📌 6. 최종 출력 조건 (OUTPUT)\n\n배경: 완전한 흰색 #FFFFFF\n\n카테고리에 해당하는 의류만 화면 중앙 배치\n\n고해상도 & 선명한 가장자리\n\n그림자 최소화 또는 제거\n\n불필요한 요소 절대 포함 금지\n\n❌ 절대 금지 항목 (ABSOLUTE PROHIBITIONS)\n\n사람·얼굴·신체 잔여 생성 또는 남김\n\n배경 일부라도 남김\n\n카테고리에 해당하지 않는 제품 포함\n\n색상 변경(1%도 불가)\n\n비율/길이 왜곡\n\n실루엣 보정\n\n존재하지 않는 요소 생성\n\n마네킹/모델 생성\n\n\"더 깔끔하게\" 같은 품질 변경 시도\n\n제품을 자동으로 대칭 보정하기 위해 비율·형태 수정하는 행위\n\n📌 최종 작업 지시 (FINAL INSTRUCTION)\n\n입력된 **카테고리(category)**를 기준으로 이미지 속에서\n해당 카테고리의 의류 하나만 정확히 찾아 인식하시오.\n\n그 의류를:\n\n원본 색상 100% 유지\n\n원본 비율·형태 100% 유지\n\n인체/배경/소품 완전 제거\n\n플랫하게 정렬\n\n완전한 흰색(#FFFFFF) 배경 위에 자연스럽게 재구성\n\n하여 전문 쇼핑몰 누끼샷 수준으로 출력하시오.\n\n카테고리에 해당하지 않는 의류·소품은 절대 포함하면 안 된다.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5072,
        1360
      ],
      "id": "7e2a852b-71c5-43d4-91fa-20f304be1b84",
      "name": "make pure background-removed prompt2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6cf78535-14a3-4ea7-be07-3ee533242fe2",
              "leftValue": "={{ $('get images API1').all()[0].json.data.mainImagesBase64.length }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3664,
        1568
      ],
      "id": "207f7865-695d-4b69-8919-79673004ba87",
      "name": "check mainImages count3"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]\n당신은 패션 제품 색상 비교에 특화된 전문 비전 모델입니다.\n입력된 두 장의 이미지를 분석하여 두 이미지 속 제품의 ‘색상(Color)’이 동일한지 여부만을 판단해야 합니다.\n\n📌 판단 기준 (Color-Only Judgment Rules)\n\n두 이미지의 제품이 다음 조건을 만족하면 \"same_color = true\",\n하나라도 다르면 \"same_color = false\" 로 판단합니다.\n\n✔ 동일하다고 판단되는 경우\n\n색상(Hue), 명도(Brightness), 채도(Saturation)가 촬영 환경 차이로 인한 미세한 변화 수준\n\n자연스러운 조명 변화(실내/실외, 밝기 차이 등)로 인한 오차\n\n그림자, 반사광으로 인한 부분적 색 변화\n\n❌ 다르다고 판단되는 경우\n\n주요 색상 자체가 다름 (예: 베이지 vs 브라운, 검정 vs 차콜 등)\n\n전체적으로 Hue 또는 Saturation이 다른 색 계열\n\n원단이 동일해 보이지 않을 정도의 강한 색조 차이\n\nAI가 자동 보정한 듯한 색 틀어짐\n\n🚫 비교 대상에서 제외되는 요소\n\n색상 판단만 수행하며 다음 요소는 판단에 포함하지 않습니다:\n\n실루엣, 핏, 길이, 버튼, 포켓, 패턴 등 디자인 변화\n\n이미지 해상도\n\n모델 또는 배경 차이\n\n전체 사진의 톤 스타일\n\n📤 출력 형식 (반드시 아래 형식으로만 출력)\n\n아래 JSON 하나만 출력합니다:\n\n{\n  \"same_color\": true | false,\n  \"reason\": \"짧고 명확한 색상 판단 근거\"\n}\n\n\n출력 외 다른 텍스트는 절대 생성하지 마십시오.\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3936,
        1584
      ],
      "id": "3392ff01-54d0-4c8c-a6ec-fc5018a9e11f",
      "name": "make pure color-judgment prompt3"
    },
    {
      "parameters": {
        "jsCode": "const urls = $('get images API1').all()[0].json.data.mainImagesBase64 || [];\nconst len = urls.length;\n\n// 사용할 인덱스 결정\nlet idx1, idx2;\n\nif (len === 2) {\n  idx1 = 0;\n  idx2 = 1;\n} else if (len >= 3) {\n  idx1 = 1;\n  idx2 = 2;\n} else {\n  // 이미지가 2개 미만이면 null 처리\n  return [\n    {\n      json: {\n        img1_base64: null,\n        img2_base64: null,\n        message: \"이미지가 2개 미만입니다.\"\n      }\n    }\n  ];\n}\n\n// Base64 순수값 추출 함수\nconst extract = (raw) => raw ? (raw.split(',')[1] || raw) : null;\n\nreturn [\n  {\n    json: {\n      img1_base64: extract(urls[idx1]),\n      img2_base64: extract(urls[idx2])\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4144,
        1584
      ],
      "id": "6030d35f-40ae-4fd3-85e4-b418f90a1942",
      "name": "make pure mainImages base64 data3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $('make pure color-judgment prompt2').all()[0].json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.img1_base64 }}\"\n        }\n      },\n {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.img2_base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\"]\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4352,
        1584
      ],
      "id": "4c2a351d-6eaf-492f-beea-dd861f7c3c7c",
      "name": "color-judgment3",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const res = $input.first().json;\n\n// text 추출\nlet raw = res.candidates?.[0]?.content?.parts?.[0]?.text ?? \"\";\n\n// 코드블록 제거\nraw = raw.replace(/```json|```/g, \"\").trim();\n\n// JSON 파싱\nlet parsed = null;\ntry {\n  parsed = JSON.parse(raw);\n} catch (e) {\n  parsed = { error: \"JSON 파싱 실패\", raw };\n}\n\nreturn [\n  {\n    json: parsed\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4560,
        1584
      ],
      "id": "61b29db1-4f37-43a2-875c-b39878d6980f",
      "name": "JSON parsing10"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6c5436a8-f43a-4c6c-95db-6ea953569747",
              "leftValue": "={{ $json.same_color }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4752,
        1584
      ],
      "id": "169845b0-d891-468a-b120-e725c300fbe2",
      "name": "is same color?3"
    },
    {
      "parameters": {
        "jsCode": "const urls = $('get images API1').all()[0].json.data.mainImagesBase64;\n\nreturn urls.map((u, index) => {\n  const pureBase64 = u.split(',')[1] || u; // \"data:image/...,\" 제거\n  return {\n    json: {\n      base64: pureBase64\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6400,
        1680
      ],
      "id": "a2c6e197-871d-4b17-9c8e-7f5306875687",
      "name": "make pure mainImage base64 data3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\" : [{\n    \"parts\": [\n      {\n          \"text\": {{ $('make pure background-removed prompt3').all()[0].json.cleanedPrompt }}\n        },\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $('resize thumbnail1').all()[0].json.ThumbnailImage_Base64 }}\"\n        }\n      },\n {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.base64 }}\"\n        }\n      }\n    ]\n  }],\n  \"generationConfig\": {\n    \"responseModalities\": [\"TEXT\", \"IMAGE\"],\n    \"imageConfig\": {\n      \"aspectRatio\": \"4:5\",\n      \"imageSize\": \"1K\"\n    }\n  } \n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6576,
        1680
      ],
      "id": "cb8c3cf8-535f-4bf6-9db9-d4b69fb3f8b8",
      "name": "create background-removed image3",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "evcIz8tBtY6ypLqT",
          "name": "Soonicorn_GeminiAPI"
        }
      }
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import base64\nfrom io import BytesIO\nfrom PIL import Image\n\noutputs = []\n\n# ==========================================================\n# 1) input 전체 반복 처리\n# ==========================================================\nfor item in _input.all():\n\n    # base64 위치 추출 (없으면 skip)\n    base64_input = item.json.get(\"candidates\", [])[0].get(\"content\", {}).get(\"parts\", [])[0].get(\"inlineData\", {}).get(\"data\")\n\n    if not base64_input:\n        outputs.append({\n            \"error\": \"base64 이미지 데이터를 찾을 수 없습니다.\",\n            \"original_item\": item.json\n        })\n        continue\n\n    # base64 decode\n    image_data = base64.b64decode(base64_input)\n\n    # ==========================================================\n    # 2) 이미지 로드\n    # ==========================================================\n    img = Image.open(BytesIO(image_data))\n\n    # ==========================================================\n    # 3) 비율 유지 + width 700px 리사이즈\n    # ==========================================================\n    target_width = 700\n    w, h = img.size\n    ratio = target_width / float(w)\n    target_height = int(h * ratio)\n\n    resized_img = img.resize((target_width, target_height), Image.LANCZOS)\n\n    # ==========================================================\n    # 4) 다시 base64로 변환\n    # ==========================================================\n    buffered = BytesIO()\n    resized_img.save(buffered, format=\"JPEG\")\n    output_base64 = base64.b64encode(buffered.getvalue()).decode(\"utf-8\")\n\n    # ==========================================================\n    # 5) output 배열에 추가\n    # ==========================================================\n    outputs.append({\n        \"width\": target_width,\n        \"height\": target_height,\n        \"CutoutImage_Base64\": output_base64\n    })\n\n# ==========================================================\n# 6) n8n Output (items list 반환)\n# ==========================================================\nreturn outputs\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6768,
        1680
      ],
      "id": "595bb41d-58a4-4824-bfbd-8681aff8f2ac",
      "name": "resize background-removed image3"
    },
    {
      "parameters": {
        "jsCode": "// 모든 input items\nconst items = $input.all();\n\n// base64만 추출하고, undefined/null/빈 문자열 제외\nconst base64List = items\n  .map(i => i.json.CutoutImage_Base64)\n  .filter(b => b); // falsy 값 제거(undefined, null, \"\", 0)\n\n// ✨ 마지막 콤마 제거 버전 ✨\n// 각 값 앞뒤에 큰따옴표만 추가하고 join(\", \")으로 연결\nconst result = base64List\n  .map(b => `\"${b}\"`)\n  .join(\", \"); // 자동으로 마지막 콤마 제거됨\n\nreturn [\n  {\n    json: {\n      CutoutImage_Base64: result\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6960,
        1680
      ],
      "id": "28e71498-88b2-4d3c-ae95-d4c1ac3fc304",
      "name": "sum background-removed image3"
    },
    {
      "parameters": {
        "content": "### Create background-removed image\n",
        "height": 80,
        "width": 336,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1520,
        1312
      ],
      "id": "2a2dfa0a-6c61-4a3e-94b1-fdc9896254f1",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "jsCode": "const prompt = `\n[시스템 역할]  \n당신은 의류 리터칭 및 패션 디지털 합성 전문가입니다.  \n두 장의 이미지를 분석하여 다음 규칙에 따라 새로운 이미지를 생성하십시오.\n\n[입력 이미지 설명]  \n- 이미지 #1 : 최종 결과에서 **모델의 얼굴, 체형, 포즈, 카메라 각도, 조명**을 그대로 유지해야 하는 기준 이미지  \n- 이미지 #2 : 모델이 입고 있는 **의류의 색상 정보만 추출**해야 하는 참고 이미지  \n\n[핵심 지시사항]\n\n1. **이미지 #1의 요소는 그대로 유지**\n   - 모델의 얼굴 특징, 체형, 헤어스타일  \n   - 포즈, 손 위치, 다리 각도  \n   - 카메라 구도, 조명 분위기  \n   - 배경과 전체적인 장면 구성  \n\n2. **이미지 #2에서 가져오는 요소**\n   - 의류의 **정확한 색상(Color only)**  \n   - 색조, 채도, 명도 등 톤 정보   \n   - *디자인이나 형태는 절대 변경하지 않음.*\n\n3. **절대 변경하거나 가져오지 말아야 할 것**\n   - 이미지 #2의 모델 얼굴·포즈  \n   - 이미지 #2의 의상 형태(디자인, 실루엣, 패턴)  \n   - 이미지 #2의 배경 및 소품  \n   - 이미지 #1의 의상 디자인은 절대 변경 금지  \n     → 오직 \"색상\"만 대체 적용  \n\n4. **최종 생성 이미지 요구사항**\n   - 이미지 #1의 옷 **형태와 질감은 유지하되**,  \n     색상만 이미지 #2의 색과 일관되게 적용  \n   - 부자연스럽거나 덩어리진 색 번짐 없이 자연스러운 재질 표현  \n   - 전체 사진 품질은 원본 이상으로 선명하고 깨끗하게  \n\n[출력 형식]  \n\"이미지 #1의 모델과 포즈는 동일하게 유지하고, 의상의 색상만 이미지 #2의 색상으로 자연스럽게 대체한 고해상도 패션 합성 이미지 생성.\"\n\n`;\n\nreturn [\n  {\n    json: {\n      cleanedPrompt: JSON.stringify(prompt)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6144,
        1680
      ],
      "id": "cb77d639-32dc-4eca-98d8-07e5f73e5d18",
      "name": "make pure background-removed prompt3"
    }
  ],
  "connections": {
    "Convert Base64 To File": {
      "main": [
        [
          {
            "node": "resize subImage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resize Image": {
      "main": [
        [
          {
            "node": "Edit Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "resize info-section image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "get images API",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get images API1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request11": {
      "main": [
        [
          {
            "node": "Code in JavaScript62",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript62": {
      "main": [
        [
          {
            "node": "HTTP Request12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get images API": {
      "main": [
        [
          {
            "node": "check category",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is accessory?": {
      "main": [
        [
          {
            "node": "make postData",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "make pure thumbnail image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make postData": {
      "main": [
        [
          {
            "node": "post images API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check category": {
      "main": [
        [
          {
            "node": "is accessory?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure base64": {
      "main": [
        [
          {
            "node": "make pure thumbnailPrompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure thumbnailPrompt": {
      "main": [
        [
          {
            "node": "create thumbnail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create thumbnail": {
      "main": [
        [
          {
            "node": "resize thumbnail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resize thumbnail": {
      "main": [
        [
          {
            "node": "make pure model-cut prompt 1",
            "type": "main",
            "index": 0
          },
          {
            "node": "make pure model-cut prompt 2",
            "type": "main",
            "index": 0
          },
          {
            "node": "make pure model-cut prompt 3",
            "type": "main",
            "index": 0
          },
          {
            "node": "make pure model-cut prompt 4",
            "type": "main",
            "index": 0
          },
          {
            "node": "make pure model-cut prompt 5",
            "type": "main",
            "index": 0
          },
          {
            "node": "make pure model-cut prompt 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create model-cut 1": {
      "main": [
        [
          {
            "node": "resize model-cut 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure model-cut prompt 1": {
      "main": [
        [
          {
            "node": "create model-cut 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure model-cut prompt 2": {
      "main": [
        [
          {
            "node": "create model-cut 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure model-cut prompt 3": {
      "main": [
        [
          {
            "node": "create model-cut 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure model-cut prompt 4": {
      "main": [
        [
          {
            "node": "create model-cut 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure model-cut prompt 5": {
      "main": [
        [
          {
            "node": "create model-cut 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure model-cut prompt 6": {
      "main": [
        [
          {
            "node": "create model-cut 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resize model-cut 1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create model-cut 2": {
      "main": [
        [
          {
            "node": "resize model-cut 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create model-cut 3": {
      "main": [
        [
          {
            "node": "resize model-cut 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create model-cut 4": {
      "main": [
        [
          {
            "node": "resize model-cut 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create model-cut 5": {
      "main": [
        [
          {
            "node": "resize model-cut 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create model-cut 6": {
      "main": [
        [
          {
            "node": "resize model-cut 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resize model-cut 2": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "resize model-cut 3": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "resize model-cut 4": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "resize model-cut 5": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "resize model-cut 6": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 5
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "merge model-cut images",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "merge model-cut images": {
      "main": [
        [
          {
            "node": "caculate subimage size",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent4": {
      "main": [
        [
          {
            "node": "JSON parsing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent4",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory4": {
      "ai_memory": [
        [
          {
            "node": "AI Agent4",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "make pure mainImages base64": {
      "main": [
        [
          {
            "node": "convert imageFIle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "convert imageFIle": {
      "main": [
        [
          {
            "node": "AI Agent4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing": {
      "main": [
        [
          {
            "node": "is background-removed image?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is background-removed image?": {
      "main": [
        [
          {
            "node": "check true items count",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "check false items count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make postData1": {
      "main": [
        [
          {
            "node": "post background-removed image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check true items count": {
      "main": [
        [
          {
            "node": "make postData1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "can create background-removed images?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check false items count": {
      "main": [
        [
          {
            "node": "can create background-removed images?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "can create background-removed images?": {
      "main": [
        [
          {
            "node": "check true items count 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "check false items count 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check true items count 1": {
      "main": [
        [
          {
            "node": "check mainImages count",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "check mainImages count1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check false items count 1": {
      "main": [
        [
          {
            "node": "check mainImages count1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check mainImages count": {
      "main": [
        [],
        [
          {
            "node": "make pure color-judgment prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure color-judgment prompt": {
      "main": [
        [
          {
            "node": "make pure mainImages base64 data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure mainImages base64 data": {
      "main": [
        [
          {
            "node": "color-judgment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "color-judgment": {
      "main": [
        [
          {
            "node": "JSON parsing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing1": {
      "main": [
        [
          {
            "node": "is same color?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is same color?": {
      "main": [
        [],
        [
          {
            "node": "make pure background-removed prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure mainImage base64 data": {
      "main": [
        [
          {
            "node": "create background-removed image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resize background-removed image": {
      "main": [
        [
          {
            "node": "sum background-removed image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sum background-removed image": {
      "main": [
        [
          {
            "node": "post background-removed image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create background-removed image": {
      "main": [
        [
          {
            "node": "resize background-removed image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure background-removed prompt": {
      "main": [
        [
          {
            "node": "make pure mainImage base64 data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check mainImages count1": {
      "main": [
        [],
        [
          {
            "node": "make pure color-judgment prompt1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure color-judgment prompt1": {
      "main": [
        [
          {
            "node": "make pure mainImages base64 data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure mainImages base64 data1": {
      "main": [
        [
          {
            "node": "color-judgment1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "color-judgment1": {
      "main": [
        [
          {
            "node": "JSON parsing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing2": {
      "main": [
        [
          {
            "node": "is same color?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is same color?1": {
      "main": [
        [],
        [
          {
            "node": "make pure background-removed prompt1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure mainImage base64 data1": {
      "main": [
        [
          {
            "node": "create background-removed image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create background-removed image1": {
      "main": [
        [
          {
            "node": "resize background-removed image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resize background-removed image1": {
      "main": [
        [
          {
            "node": "sum background-removed image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sum background-removed image1": {
      "main": [
        [
          {
            "node": "post background-removed image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure info-section judgment prompt1": {
      "main": [
        [
          {
            "node": "make pure info-section judgment prompt2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure info-section judgment prompt2": {
      "main": [
        [
          {
            "node": "get subImageBase1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "caculate subimage size": {
      "main": [
        [
          {
            "node": "make pure info-section judgment prompt1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resize subImage": {
      "main": [
        [
          {
            "node": "Analyze subImage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze subImage": {
      "main": [
        [
          {
            "node": "JSON parsing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing3": {
      "main": [
        [
          {
            "node": "get subImageBase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get subImageBase": {
      "main": [
        [
          {
            "node": "Convert Base64 To File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get subImageBase1": {
      "main": [
        [
          {
            "node": "Convert Base64 To File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Base64 To File1": {
      "main": [
        [
          {
            "node": "Resize Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Image": {
      "main": [
        [
          {
            "node": "Analyze subImage1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze subImage1": {
      "main": [
        [
          {
            "node": "JSON parsing4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing4": {
      "main": [
        [
          {
            "node": "get subImageBase2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get subImageBase2": {
      "main": [
        [
          {
            "node": "Convert Base64 To File2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Base64 To File2": {
      "main": [
        [
          {
            "node": "Resize Image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resize Image1": {
      "main": [
        [
          {
            "node": "Edit Image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Image1": {
      "main": [
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resize info-section image": {
      "main": [
        [
          {
            "node": "post image API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "post image API": {
      "main": [
        [
          {
            "node": "make pure mainImages base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing5": {
      "main": [
        [
          {
            "node": "is thumbnail occluded?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "convert imageFIle1": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure thumbnail image": {
      "main": [
        [
          {
            "node": "convert imageFIle1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "JSON parsing5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is thumbnail occluded?": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "make pure background-removed prompt1": {
      "main": [
        [
          {
            "node": "make pure mainImage base64 data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Same Image?1": {
      "main": [
        [
          {
            "node": "check true items count1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "check false items count1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Make pure prompt": {
      "main": [
        [
          {
            "node": "Make pure mainimages & background-removeds",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Make pure mainimages & background-removeds": {
      "main": [
        [
          {
            "node": "Check background-removed images",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check background-removed images": {
      "main": [
        [
          {
            "node": "JSON parsing6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing6": {
      "main": [
        [
          {
            "node": "Is Same Image?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get images API1": {
      "main": [
        [
          {
            "node": "check category1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is accessory?1": {
      "main": [
        [],
        [
          {
            "node": "get background-removed count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check category1": {
      "main": [
        [
          {
            "node": "is accessory?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure base": {
      "main": [
        [
          {
            "node": "make pure thumbnailPrompt1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure thumbnailPrompt1": {
      "main": [
        [
          {
            "node": "create thumbnail1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create thumbnail1": {
      "main": [
        [
          {
            "node": "resize thumbnail1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "JSON parsing7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "convert imageFIle2": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing7": {
      "main": [
        [
          {
            "node": "is thumbnail occluded?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure thumbnail image1": {
      "main": [
        [
          {
            "node": "convert imageFIle2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is thumbnail occluded?1": {
      "main": [
        [],
        [
          {
            "node": "make pure base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get background-removed count": {
      "main": [
        [
          {
            "node": "check background-removed count greater than 0?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check background-removed count greater than 0?": {
      "main": [
        [
          {
            "node": "Make pure prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent5": {
      "main": [
        [
          {
            "node": "JSON parsing8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent5",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory5": {
      "ai_memory": [
        [
          {
            "node": "AI Agent5",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "make pure mainImages base": {
      "main": [
        [
          {
            "node": "convert imageFIle3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "convert imageFIle3": {
      "main": [
        [
          {
            "node": "AI Agent5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing8": {
      "main": [
        [
          {
            "node": "is background-removed image?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is background-removed image?1": {
      "main": [
        [
          {
            "node": "check true items count2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "check false items count2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make postData2": {
      "main": [
        [
          {
            "node": "post background-removed image2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check true items count2": {
      "main": [
        [
          {
            "node": "make postData2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "can create background-removed images?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check false items count2": {
      "main": [
        [
          {
            "node": "can create background-removed images?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "can create background-removed images?1": {
      "main": [
        [
          {
            "node": "check true items count ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "check false items count ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check true items count ": {
      "main": [
        [
          {
            "node": "check mainImages count2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "check mainImages count3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check false items count ": {
      "main": [
        [
          {
            "node": "check mainImages count3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check mainImages count2": {
      "main": [
        [],
        [
          {
            "node": "make pure color-judgment prompt2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure color-judgment prompt2": {
      "main": [
        [
          {
            "node": "make pure mainImages base64 data2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure mainImages base64 data2": {
      "main": [
        [
          {
            "node": "color-judgment2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "color-judgment2": {
      "main": [
        [
          {
            "node": "JSON parsing9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing9": {
      "main": [
        [
          {
            "node": "is same color?2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is same color?2": {
      "main": [
        [],
        [
          {
            "node": "make pure background-removed prompt2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure mainImage base64 data2": {
      "main": [
        [
          {
            "node": "create background-removed image2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resize background-removed image2": {
      "main": [
        [
          {
            "node": "sum background-removed image2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sum background-removed image2": {
      "main": [
        [
          {
            "node": "post background-removed image3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create background-removed image2": {
      "main": [
        [
          {
            "node": "resize background-removed image2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure background-removed prompt2": {
      "main": [
        [
          {
            "node": "make pure mainImage base64 data2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check mainImages count3": {
      "main": [
        [],
        [
          {
            "node": "make pure color-judgment prompt3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure color-judgment prompt3": {
      "main": [
        [
          {
            "node": "make pure mainImages base64 data3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure mainImages base64 data3": {
      "main": [
        [
          {
            "node": "color-judgment3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "color-judgment3": {
      "main": [
        [
          {
            "node": "JSON parsing10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parsing10": {
      "main": [
        [
          {
            "node": "is same color?3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is same color?3": {
      "main": [
        [],
        [
          {
            "node": "make pure thumbnail image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure mainImage base64 data3": {
      "main": [
        [
          {
            "node": "create background-removed image3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create background-removed image3": {
      "main": [
        [
          {
            "node": "resize background-removed image3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resize background-removed image3": {
      "main": [
        [
          {
            "node": "sum background-removed image3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sum background-removed image3": {
      "main": [
        [
          {
            "node": "post background-removed image3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "make pure background-removed prompt3": {
      "main": [
        [
          {
            "node": "make pure mainImage base64 data3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check true items count1": {
      "main": [
        [],
        [
          {
            "node": "make pure mainImages base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check false items count1": {
      "main": [
        [
          {
            "node": "make pure mainImages base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resize thumbnail1": {
      "main": [
        [
          {
            "node": "make pure background-removed prompt3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "tags": [],
  "versionId": "9c9ecb8f-921f-4f6f-ad2a-153fe03a8308"
}